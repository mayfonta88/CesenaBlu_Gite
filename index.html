<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Cesena Blu - Gestione Immersioni</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        input, button, select {
          width: 100%;
          box-sizing: border-box;
          font-size: 16px;
        }
        .nav-btn {
          display: block;
          width: 100%;
          margin-bottom: 10px;
        }
      }
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f7fa; }
    input, button, select { padding: 8px; margin: 5px 0; }
    .section { border: 1px solid #ccc; border-radius: 5px; background: #fff; margin-top: 10px; padding: 10px; }
    .hidden { display: none; }
    .nav-btn { margin: 5px; padding: 10px 15px; background: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .nav-btn:hover { background-color: #0056b3; }
    #logoutBtn { float: right; background: red; }
    
    .courseSelect, .courseInput { min-width:90px }
    
    .checklist-item {
      display: flex;
      align-items: center;
      gap: 6px;         /* spazio ridotto tra checkbox e testo */
      margin: 2px 0;    /* meno spazio verticale */
      justify-content: flex-start; /* allinea tutto a sinistra */
    }
      .checklist-item input[type="checkbox"] {
        margin-left: 0;
        width: 16px;
        height: 16px;
      }
      
      .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #007BFF;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

    
  </style>
</head>
<body>
    <div id="loader" style="text-align: center; margin-top: 100px;">
      <div class="spinner"></div>
      <p style="margin-top: 15px;">Caricamento...</p>
    </div>
  <div id="authSection">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="register()">Registrati</button>
    <button onclick="resetPassword()">Recupera Password</button>
    <div id="authMessage"></div>
  </div>

  <div id="mainApp" class="hidden">
      <img src="https://res.cloudinary.com/mymagazzino/image/upload/v1748973122/Loghi%20App/sespy19fmpgp5xakdgyz.png" alt="Logo Cesena Blu" style="height: 40px; margin-left: 5px;">
    
    <h1 style="display: flex; align-items: left; justify-content: space-between;">
      <span>Gestione Gite - Cesena Blu</span>
      
    </h1>
    <button id="logoutBtn" onclick="logout()">X Logout</button>
    <button id="apriImpostazioni">‚öôÔ∏è Impostazioni</button>
    <div id="sezioneImpostazioni" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
        <h3>Gestione Utenti</h3>
        <div style="overflow-x: auto;">
          <table id="tabellaUtenti" border="1" style="width: 100%; min-width: 600px; margin-bottom: 20px;">
            <thead>
              <tr>
                <th>Email</th>
                <th>Approvato</th>
                <th>Tipo Accesso</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="listaUtenti"></tbody>
          </table>
        </div>
        </div>
    <div id="bloccoAggiungiGita">
      <input type="text" id="nomeGita" placeholder="Nome della gita">
      <input type="text" id="dateGita" placeholder="Scegli giorni" readonly>
      <button onclick="aggiungiGita()">üèùÔ∏è Aggiungi Gita</button>
    </div>
    <div id="messaggio"></div>
    <h2 id="titoloGita">Gite</h2>
    <div id="listaGite"></div>
    <button id="btnArchivio" class="nav-btn" style="background:#6c757d;display:none;margin-right:10px">üìÅ Archivio</button>
    <div id="listaGiteArchivio" style="display:none;"></div>
    <div id="sezioniGita" class="hidden">
      <div id="sezioneModifica"></div>
      <button class="nav-btn" onclick="toggleGitaSection('imbarcazioni')">üõ•Ô∏è Sezione Imbarcazioni</button>
      <button class="nav-btn" onclick="toggleGitaSection('tuffi')">üóìÔ∏è Sezione Calendario Tuffi</button>
      <button class="nav-btn" onclick="toggleGitaSection('importa')">‚úÖ Sezione Iscritti</button>
      <button class="nav-btn" onclick="toggleGitaSection('organizza')">ü§ø Sezione Organizzazione Immersioni</button>
      <button class="nav-btn" onclick="confermaEsportaRiepilogo()">üìú Esporta Riepilogo Organizzazione</button>
      <button class="nav-btn" onclick="confermaEsportaPresenze()">üìã Esporta Elenco Presenze</button>
      
      

      <div id="sezioneImbarcazioni" class="section hidden">
  <h3>Gestione Imbarcazioni</h3>
  <div>
    <input type="text" id="nomeImbarcazione" placeholder="Nome Imbarcazione">
    <input type="number" id="capienzaImbarcazione" placeholder="Capienza Massima" min="1">
    <select id="tipologiaImbarcazione">
      <option value="Gommone">Gommone</option>
      <option value="Barca">Barca</option>
    </select>
    <button onclick="aggiungiImbarcazione()">Aggiungi</button>
  </div>
  <div id="listaImbarcazioni"></div>
</div>
      <div id="sezioneTuffi" class="section hidden">
        <h3>Calendario Tuffi</h3>
        <div id="tuffiContainer"></div>
        <button id="btnSalvaTuffi" onclick="salvaTuffi()" style="background-color: green; color: white;">üíæ Salva Orari Tuffi</button>
      </div>
      <div id="sezioneImporta" class="section hidden">
        <h3>Importazione Iscritti (Excel)</h3>
        <input type="file" id="fileIscritti" accept=".xlsx" onchange="preElaboraIscritti(event)">
        <div id="riepilogoIscritti" style="margin-top:10px"></div>
<h4>Elenco Partecipanti salvati</h4>
<div id="listaPartecipantiSalvati"
     style="max-height:250px;overflow:auto;border:1px solid #ccc;padding:6px"></div>
        <button id="btnEliminaIscritti" style="margin-top: 10px; background-color: red; color: white;">üóëÔ∏è Elimina Iscritti</button>

      </div>
      
      <div id="sezioneOrganizza" class="section hidden">
          <h3>Organizzazione Immersione</h3>
          <button id="btnScaricaProgrammaCompleto" onclick="confermaScaricaProgrammaCompleto()"
              style="background-color: #007bff; color: white; margin-bottom: 10px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">
              üìÑ Scarica Programma Completo
          </button>
          
          <label for="menuTuffi">Scegli giorno e orario:</label>
          <select id="menuTuffi"></select>
          <label for="menuMezzi">Scegli il mezzo:</label>
          <select id="menuMezzi"></select>
          </select>
          <div id="organizzazioneImmersioneContainer"></div>
          
          
          <script>
              if (typeof firebase === 'undefined') {
                  alert('Errore nel caricamento di Firebase. Controlla la connessione.');
              } else {
                  if (!firebase.apps.length) {
                      const firebaseConfig = {
                          apiKey: "AIzaSyDU0wDi_ToUJkCkoSBQCsaJsr26nHC6HYg",
                          authDomain: "gite-cesena-blu.firebaseapp.com",
                          projectId: "gite-cesena-blu",
                          storageBucket: "gite-cesena-blu.appspot.com",
                          messagingSenderId: "837199090946",
                          appId: "1:837199090946:web:09ff5e2c02e8a538149e1b"
                      };
                      firebase.initializeApp(firebaseConfig);
                      
                  }
                  
                  document.getElementById('authSection').style.display = 'none';
                  document.getElementById('mainApp').classList.add('hidden');
                  document.getElementById('loader').style.display = 'block';
                  
                  document.querySelector('button.nav-btn[onclick="confermaEsportaRiepilogo()"]').style.backgroundColor = "#28a745";
                  document.querySelector('button.nav-btn[onclick="confermaEsportaRiepilogo()"]').style.color = "white";
                  document.querySelector('button.nav-btn[onclick="confermaEsportaPresenze()"]').style.backgroundColor = "#28a745";
                  document.querySelector('button.nav-btn[onclick="confermaEsportaPresenze()"]').style.color = "white";
                  
                  const auth = firebase.auth();
                  const db = firebase.firestore();
                  let currentUser = null;
                  const adminEmails = ["mattiafontana@gmail.com", "direzionetecnica@cesenablu.it"];
                  let currentGitaId = null;
                  
                  
                  function showMsg(testo) {
                      const el = document.getElementById('messaggio');
                      el.textContent = testo;
                      setTimeout(() => el.textContent = '', 3000);
                  }
                  document.getElementById("apriImpostazioni").onclick = () => {
                      const sez = document.getElementById("sezioneImpostazioni");
                      sez.style.display = sez.style.display === "none" ? "block" : "none";
                      caricaListaUtenti();
                  };
                  
                  document.getElementById('btnEliminaIscritti').addEventListener('click', async () => {
                      if (!currentGitaId) {
                          alert("Seleziona una gita prima di procedere.");
                          return;
                      }
                      
                      const doc = await db.collection("gite").doc(currentGitaId).get();
                      const gita = doc.data();
                      
                      if (!gita || !gita.partecipanti || gita.partecipanti.length === 0) {
                          alert("Non ci sono iscritti da eliminare.");
                          return;
                      }
                      
                      // Controllo presenze
                      let presenzePresenti = false;
                      for (const nome in (gita.presenze || {})) {
                          const presenzePerPersona = gita.presenze[nome];
                          if (Object.values(presenzePerPersona).some(v => v === true || v === false)) {
                              presenzePresenti = true;
                              break;
                          }
                      }
                      
                      if (presenzePresenti) {
                          alert("Non puoi eliminare gli iscritti: sono presenti delle presenze registrate.");
                          return;
                      }
                      
                      const conferma = confirm("Sei sicuro di voler eliminare tutti gli iscritti? Questa operazione non √® reversibile.");
                      if (!conferma) return;
                      
                      await db.collection("gite").doc(currentGitaId).update({
                          partecipanti: firebase.firestore.FieldValue.delete()
                      });
                      
                      alert("Iscritti eliminati con successo.");
                      location.reload();
                  });
                  
                  function confermaScaricaProgrammaCompleto() {
                      if (!currentGitaId) {
                          alert("Seleziona una gita prima di scaricare il programma completo.");
                          return;
                      }

                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const dati = doc.data();
                          if (!dati.organizzazione || Object.keys(dati.organizzazione).length === 0) {
                              alert("Errore: nessuna organizzazione trovata per questa gita.");
                              return;
                          }

                          const ok = confirm("Vuoi generare il PDF del Programma Completo?");
                          if (ok) scaricaProgrammaCompleto();
                      }).catch(err => {
                          console.error("Errore nel recupero della gita:", err);
                          alert("Errore durante il recupero dei dati della gita.");
                      });
                  }

                  
                  function confermaEsportaRiepilogo() {
                      if (!currentGitaId) {
                          alert("Seleziona una gita prima di esportare il riepilogo.");
                          return;
                      }

                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const dati = doc.data();
                          if (!dati.organizzazione || Object.keys(dati.organizzazione).length === 0) {
                              alert("Errore: nessuna organizzazione trovata per questa gita.");
                              return;
                          }

                          if (confirm("Vuoi esportare il Riepilogo dell'Organizzazione in Excel?")) {
                              esportaRiepilogo();
                          }
                      }).catch(err => {
                          console.error("Errore nel recupero della gita:", err);
                          alert("Errore durante il recupero dei dati della gita.");
                      });
                  }

                  
                  function confermaEsportaPresenze() {
                      if (!currentGitaId) {
                          alert("Seleziona una gita prima di esportare le presenze.");
                          return;
                      }

                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const dati = doc.data();
                          if (!dati.presenze || Object.keys(dati.presenze).length === 0) {
                              alert("Errore: nessuna presenza registrata per questa gita.");
                              return;
                          }

                          if (confirm("Vuoi esportare l'Elenco Presenze in Excel?")) {
                              esportaElencoPresenze();
                          }
                      }).catch(err => {
                          console.error("Errore nel recupero della gita:", err);
                          alert("Errore durante il recupero dei dati della gita.");
                      });
                  }

                  
                  
                  function login() {
                      const email = document.getElementById('email').value;
                      const password = document.getElementById('password').value;
                      auth.signInWithEmailAndPassword(email, password)
                      .then(() => location.reload())
                      .catch(err => document.getElementById('authMessage').textContent = err.message);
                  }
                  
                  function register() {
                      const email = document.getElementById('email').value;
                      const password = document.getElementById('password').value;
                      
                      auth.createUserWithEmailAndPassword(email, password)
                      .then(userCredential => {
                          const user = userCredential.user;
                          // crea documento con approvato = false
                          return db.collection("utenti").doc(email).set({
                              approvato: false,
                              tipo: "Limitato"
                          });
                      })
                      .then(() => {
                          document.getElementById("authMessage").innerHTML = "Registrazione completata. Attendi l'approvazione.";
                          auth.signOut();
                      })
                      .catch(err => document.getElementById('authMessage').textContent = err.message);
                  }
                  
                  function resetPassword() {
                      const email = document.getElementById('email').value;
                      if (!email) return alert('Inserisci un email valida');
                      auth.sendPasswordResetEmail(email)
                      .then(() => alert('Email inviata'))
                      .catch(err => alert(err.message));
                  }
                  
                  function logout() {
                      const conferma = confirm("Sei sicuro di voler uscire?");
                      if (!conferma) return;
                      
                      auth.signOut().then(() => location.reload());
                  }
                  
                  function caricaListaUtenti() {
                      const lista = document.getElementById("listaUtenti");
                      lista.innerHTML = "";
                      
                      db.collection("utenti").get().then(snapshot => {
                          snapshot.forEach(doc => {
                              const dati = doc.data();
                              const email = doc.id;
                              const approvato = dati.approvato === true;
                              const tipo = dati.tipo || "Limitato";
                              
                              const tr = document.createElement("tr");
                              
                              tr.innerHTML = `
              <td>${email}</td>
              <td>${approvato ? "‚úÖ" : "‚ùå"}</td>
              <td>
                <select onchange="aggiornaTipoAccesso('${email}', this.value)">
                  <option value="Completo" ${tipo === "Completo" ? "selected" : ""}>Completo</option>
                  <option value="Limitato" ${tipo === "Limitato" ? "selected" : ""}>Limitato</option>
                </select>
              </td>
              <td>
                <button onclick="approvaUtente('${email}', true)">‚úîÔ∏è Approva</button>
                <button onclick="approvaUtente('${email}', false)">‚ùå Rimuovi</button>
                <button onclick="eliminaUtente('${email}')">üóëÔ∏è Elimina</button>
              </td>
            `;
            
            lista.appendChild(tr);
                          });
                      });
                  }
                  
                  function approvaUtente(email, stato) {
                      db.collection("utenti").doc(email).update({
                          approvato: stato
                      }).then(() => caricaListaUtenti());
                  }
                  
                  function aggiornaTipoAccesso(email, tipo) {
                      db.collection("utenti").doc(email).update({
                          tipo: tipo
                      }).then(() => caricaListaUtenti());
                  }
                  
                  function eliminaUtente(email) {
                      if (confirm("Sei sicuro di voler eliminare questo utente?")) {
                          db.collection("utenti").doc(email).delete().then(() => caricaListaUtenti());
                      }
                  }
                  
                  
                  function toggleGitaSection(sectionId) {
                      ['Imbarcazioni','Tuffi','Importa','Organizza'].forEach(id=>{
                          document.getElementById('sezione'+id).classList.add('hidden');
                      });
                      document.getElementById(
                                              'sezione'+sectionId.charAt(0).toUpperCase()+sectionId.slice(1)
                                              ).classList.remove('hidden');
                                              console.log('[ORG] avviata ‚Äì gita:', currentGitaId);
                                              if (sectionId === 'importa')   caricaPartecipantiEsistenti();
                                              if (sectionId === 'importa')   aggiornaStatistichePerCorso();
                                              if (sectionId === 'organizza') caricaOrganizzazioneImmersione();
                  }
                  
                  function scaricaProgrammaCompleto() {
                      const { jsPDF } = window.jspdf;
                      const doc = new jsPDF();
                      const logoUrls = [
                                        "https://res.cloudinary.com/mymagazzino/image/upload/v1748814243/Loghi%20App/bmyvpktpv2jni4f4ocvp.png",
                                        "https://res.cloudinary.com/mymagazzino/image/upload/v1748973122/Loghi%20App/sespy19fmpgp5xakdgyz.png"
                                        ];
                                        
                                        let y = 10;
                                        let immagini = [];
                                        
                                        
                                        function formatTitolo(s) {
                                            return (s || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                                        }
                                        
                                        function stimaAltezzaTabella(dati) {
                                            return 8 + dati.length * 8;
                                        }
                                        
                                        function disegnaLoghi() {
                                            let x = (doc.internal.pageSize.getWidth() - immagini.reduce((acc, i) => acc + i.width, 0) - 10 * (immagini.length - 1)) / 2;
                                            immagini.forEach(img => {
                                                doc.addImage(img.base64, 'PNG', x, 10, img.width, 20);
                                                x += img.width + 10;
                                            });
                                            y = 35;
                                        }
                                        
                                        function caricaLoghi(callback) {
                                            let caricati = 0;
                                            logoUrls.forEach((url, i) => {
                                                fetch(url)
                                                .then(r => r.blob())
                                                .then(blob => new Promise(resolve => {
                                                    const reader = new FileReader();
                                                    reader.onloadend = () => resolve(reader.result);
                                                    reader.readAsDataURL(blob);
                                                }))
                                                .then(base64 => {
                                                    const img = new Image();
                                                    img.onload = () => {
                                                        const aspect = img.width / img.height;
                                                        const height = 20;
                                                        const width = height * aspect;
                                                        immagini[i] = { base64, width };
                                                        caricati++;
                                                        if (caricati === logoUrls.length) callback();
                                                    };
                                                    img.src = base64;
                                                });
                                            });
                                        }
                                        
                                        caricaLoghi(() => {
                                            db.collection("gite").doc(currentGitaId).get().then(gitaDoc => {
                                                const gita = gitaDoc.data();
                                                const organizzazione = gita.organizzazione || {};
                                                const partecipantiTotali = gita.partecipanti || [];
                                                const periodo = new Date(gita.dateRange[0]).toLocaleDateString('it-IT') + " - " + new Date(gita.dateRange[1]).toLocaleDateString('it-IT');
                                                const dateOrari = [];
                                                
                                                for (const data in organizzazione) {
                                                    for (const orario in organizzazione[data]) {
                                                        dateOrari.push({ data, orario });
                                                    }
                                                }
                                                
                                                dateOrari.sort((a, b) => new Date(`${a.data}T${a.orario}`) - new Date(`${b.data}T${b.orario}`));
                                                
                                                disegnaLoghi();
                                                
                                                // üìÑ Pagina introduttiva con riepilogo generale
                                                doc.setFontSize(16);
                                                doc.text(`${gita.nome} | Riepilogo Generale`, doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
                                                y += 15;
                                                
                                                // Tabella riepilogo generale
                                                const header = [["#", "Data", "Orario", "Imbarcazione", "Tipo", "Capienza", "Corsi", "Totale Sub", "Allievi/Sub", "Staff", "Punto Immersione", "Profondit√† Massima"]];
                                                const body = [];
                                                
                                                let index = 1;
                                                for (const { data, orario } of dateOrari) {
                                                    const mezzi = organizzazione[data][orario] || [];
                                                    mezzi.forEach(mezzo => {
                                                        const lista = mezzo.persone || [];
                                                        const allievi = [], staff = [];
                                                        const corsiSet = new Set();
                                                        
                                                        lista.forEach(p => {
                                                            const nome = typeof p === "string" ? p : p.nome;
                                                            const pGlobale = partecipantiTotali.find(x => x.nome === nome) || {};
                                                            const corso = typeof p === "object" ? (p.corso || pGlobale.corso || '') : pGlobale.corso || '';
                                                            const categoria = typeof p === "object" ? (p.categoria || pGlobale.categoria || '') : pGlobale.categoria || '';
                                                            const catLower = categoria.toLowerCase();
                                                            if (corso) corsiSet.add(corso);
                                                            if (["istruttore", "aiutoistruttore", "divemaster"].includes(catLower)) staff.push(nome);
                                                            else allievi.push(nome);
                                                        });
                                                        
                                                        body.push([
                                                                   index++,
                                                                   new Date(data).toLocaleDateString('it-IT'),
                                                                   orario,
                                                                   mezzo.nome || "-",
                                                                   mezzo.tipo || "-",
                                                                   mezzo.capienza || "-",
                                                                   Array.from(corsiSet).join(" / ") || "-",
                                                                   lista.length,
                                                                   allievi.length,
                                                                   staff.length,
                                                                   mezzo.punto || "-",
                                                                   mezzo.profondita ? `${mezzo.profondita} m` : "-"
                                                                   ]);
                                                    });
                                                }
                                                
                                                doc.autoTable({
                                                    startY: y,
                                                    head: header,
                                                    body: body,
                                                    styles: { fontSize: 8 },
                                                    headStyles: { fillColor: [0, 123, 255] },
                                                    theme: 'grid',
                                                    margin: { top: 10 },
                                                    tableWidth: 'auto'
                                                });
                                                
                                                doc.addPage(); // passa alla pagina successiva
                                                disegnaLoghi(); // re-inserisce i loghi
                                                
                                                
                                                let ultimoGiorno = null;
                                                
                                                function next(i) {
                                                    if (i >= dateOrari.length) {
                                                        generaRiepilogoCorsi();
                                                        return;
                                                    }
                                                    
                                                    const { data, orario } = dateOrari[i];
                                                    
                                                    if (ultimoGiorno && ultimoGiorno !== data) {
                                                        doc.addPage();
                                                        disegnaLoghi();
                                                    }
                                                    ultimoGiorno = data;
                                                    
                                                    const mezzi = organizzazione[data][orario] || [];
                                                    
                                                    mezzi.forEach(mezzo => {
                                                        const lista = mezzo.persone || [];
                                                        const allievi = [], staff = [];
                                                        const corsiSet = new Set();
                                                        
                                                        lista.forEach(p => {
                                                            const nome = typeof p === "string" ? p : p.nome;
                                                            const pGlobale = partecipantiTotali.find(x => x.nome === nome) || {};
                                                            const corso = typeof p === "object" ? (p.corso || pGlobale.corso || '') : pGlobale.corso || '';
                                                            const categoria = typeof p === "object" ? (p.categoria || pGlobale.categoria || '') : pGlobale.categoria || '';
                                                            const catLower = (categoria || '').toLowerCase();
                                                            const obj = { nome, corso };
                                                            if (corso) corsiSet.add(corso);
                                                            if (["istruttore", "aiutoistruttore", "divemaster"].includes(catLower)) staff.push(obj);
                                                            else allievi.push(obj);
                                                        });
                                                        
                                                        const dataLabel = new Date(data).toLocaleDateString('it-IT');
                                                        const titolo = `${gita.nome} | ${dataLabel} - ${orario} | ${mezzo.nome} (${mezzo.tipo})`;
                                                        
                                                        doc.setFontSize(11);
                                                        doc.text(titolo, 10, y); y += 6;
                                                        if (mezzo.punto) { doc.setFontSize(9); doc.text(`Punto Immersione: ${mezzo.punto}`, 10, y); y += 5; }
                                                        if (mezzo.profondita) { doc.setFontSize(9); doc.text(`Profondit√† Massima: ${mezzo.profondita} metri`, 10, y); y += 5; }
                                                        
                                                        const corsiUniti = Array.from(corsiSet).filter(Boolean).join(" e ");
                                                        if (corsiUniti) { doc.setFontSize(10); doc.text(`Corso: ${formatTitolo(corsiUniti)}`, 10, y); y += 6; }
                                                        
                                                        const colWidth = 90;
                                                        const spazioLaterale = 10;
                                                        const marginLeftAllievi = 10;
                                                        const marginLeftStaff = marginLeftAllievi + colWidth + spazioLaterale;
                                                        
                                                        const tableOptions = (startX, title, data) => ({
                                                            startY: y,
                                                            margin: { left: startX },
                                                            head: [[title, "Nome"]],
                                                            body: data.map((p, i) => [i + 1, formatTitolo(p.nome)]),
                                                            theme: 'grid',
                                                            styles: { fontSize: 8, cellPadding: 2 },
                                                            headStyles: { fillColor: [0, 123, 255] },
                                                            tableWidth: colWidth,
                                                            pageBreak: 'avoid'
                                                        });
                                                        
                                                        const altezzaAllievi = stimaAltezzaTabella(allievi);
                                                        const altezzaStaff = stimaAltezzaTabella(staff);
                                                        const maxAltezzaStimata = Math.max(altezzaAllievi, altezzaStaff);
                                                        
                                                        if (maxAltezzaStimata + 10 > doc.internal.pageSize.getHeight() - y) {
                                                            doc.addPage();
                                                            disegnaLoghi();
                                                        }
                                                        
                                                        let yAfterAllievi = y;
                                                        if (allievi.length > 0) {
                                                            doc.autoTable(tableOptions(marginLeftAllievi, "Allievi/Sub", allievi));
                                                            yAfterAllievi = doc.lastAutoTable.finalY;
                                                        }
                                                        
                                                        let yAfterStaff = y;
                                                        if (staff.length > 0) {
                                                            doc.autoTable(tableOptions(marginLeftStaff, "Staff", staff));
                                                            yAfterStaff = doc.lastAutoTable.finalY;
                                                        }
                                                        
                                                        y = Math.max(yAfterAllievi, yAfterStaff) + 10;
                                                    });
                                                    
                                                    next(i + 1);
                                                }
                                                
                                                function generaRiepilogoCorsi() {
                                                    const corsiDettagli = {};
                                                    const nomiDettagli = {};
                                                    for (const { data, orario } of dateOrari) {
                                                        const mezzi = organizzazione[data][orario] || [];
                                                        mezzi.forEach(mezzo => {
                                                            const lista = mezzo.persone || [];
                                                            lista.forEach(p => {
                                                                const nome = typeof p === "string" ? p : p.nome;
                                                                const pGlobale = partecipantiTotali.find(x => x.nome === nome) || {};
                                                                const corso = typeof p === "object" ? (p.corso || pGlobale.corso || '') : pGlobale.corso || '';
                                                                const categoria = typeof p === "object" ? (p.categoria || pGlobale.categoria || '') : pGlobale.categoria || '';
                                                                if (corso) {
                                                                    if (!corsiDettagli[corso]) corsiDettagli[corso] = [];
                                                                    corsiDettagli[corso].push({
                                                                        data: new Date(data).toLocaleDateString('it-IT'),
                                                                        orario,
                                                                        punto: mezzo.punto || '-',
                                                                        profondita: mezzo.profondita ? mezzo.profondita + ' m' : '-',
                                                                        mezzo: mezzo.nome || '-'
                                                                    });
                                                                }
                                                                if (!nomiDettagli[nome]) nomiDettagli[nome] = [];
                                                                nomiDettagli[nome].push({
                                                                    data: new Date(data).toLocaleDateString('it-IT'),
                                                                    orario,
                                                                    punto: mezzo.punto || '-',
                                                                    profondita: mezzo.profondita ? mezzo.profondita + ' m' : '-',
                                                                    categoria: categoria || '-',
                                                                    corso: corso || '-',                 // üëà nuovo campo
                                                                    mezzo: mezzo.nome || '-'
                                                                });
                                                            });
                                                        });
                                                    }
                                                    
                                                    doc.addPage();
                                                    disegnaLoghi();
                                                    
                                                    doc.setFontSize(13);
                                                    doc.setFontSize(13);
                                                    doc.text(`${gita.nome} | Riepilogo per Corso`, 105, y, { align: "center" });
                                                    y += 10;
                                                    
                                                    const corsiOrdinati = Object.keys(corsiDettagli).sort();
                                                    
                                                    const getBody = (dettagli) => {
                                                        const visti = new Set();
                                                        const unici = [];
                                                        dettagli.forEach(t => {
                                                            const chiave = `${t.data}|${t.orario}|${t.punto}|${t.profondita}|${t.mezzo}`;
                                                            if (!visti.has(chiave)) {
                                                                visti.add(chiave);
                                                                unici.push(t);
                                                            }
                                                        });
                                                        return unici.map((t, j) => [
                                                                                    j + 1,
                                                                                    t.data,
                                                                                    t.orario,
                                                                                    t.punto,
                                                                                    t.profondita,
                                                                                    t.mezzo || '-'
                                                                                    ]);
                                                    };
                                                    
                                                    for (const corso of corsiOrdinati) {
                                                        if (y > 230) { doc.addPage(); disegnaLoghi(); y = 35; }
                                                        
                                                        doc.setFontSize(10);
                                                        doc.text(`Corso: ${formatTitolo(corso)}`, 10, y);
                                                        y += 5;
                                                        
                                                        doc.autoTable({
                                                            startY: y,
                                                            head: [["#", "Data", "Orario", "Punto Immersione", "Profondit√†", "Mezzo"]],
                                                            body: getBody(corsiDettagli[corso]),
                                                            margin: { left: 10 },
                                                            theme: 'grid',
                                                            styles: { fontSize: 8 },
                                                            headStyles: { fillColor: [52, 152, 219] },
                                                            tableWidth: 'auto'
                                                        });
                                                        
                                                        y = doc.lastAutoTable.finalY + 10;
                                                    }
                                                    
                                                    // Riepilogo per Nominativo
                                                    doc.addPage();
                                                    disegnaLoghi();
                                                    doc.setFontSize(13);
                                                    doc.text(`${gita.nome} | Riepilogo per Partecipante`, 105, y, { align: "center" });
                                                    
                                                    y += 10;
                                                    
                                                    const nomiOrdinati = Object.keys(nomiDettagli).sort();
                                                    const getBodyNomi = (dettagli) => {
                                                        const visti = new Set();
                                                        const unici = [];
                                                        dettagli.forEach(t => {
                                                            const chiave = `${t.data}|${t.orario}|${t.punto}|${t.profondita}|${t.categoria}`;
                                                            if (!visti.has(chiave)) {
                                                                visti.add(chiave);
                                                                unici.push(t);
                                                            }
                                                        });
                                                        return unici.map((t, j) => [
                                                                                    j + 1,
                                                                                    t.data,
                                                                                    t.orario,
                                                                                    t.punto,
                                                                                    t.profondita,
                                                                                    t.categoria,
                                                                                    t.corso,
                                                                                    t.mezzo
                                                                                    ]);
                                                    };
                                                    
                                                    nomiOrdinati.forEach(nome => {
                                                        if (y > 230) { doc.addPage(); disegnaLoghi(); y = 35; }
                                                        doc.setFontSize(10);
                                                        doc.text(`Partecipante: ${formatTitolo(nome)}`, 10, y);
                                                        y += 5;
                                                        doc.autoTable({
                                                            startY: y,
                                                            head: [["#", "Data", "Orario", "Punto", "Profondit√†", "Categoria", "Corso", "Mezzo"]],
                                                            body: getBodyNomi(nomiDettagli[nome]),
                                                            margin: { left: 10 },
                                                            theme: 'grid',
                                                            styles: { fontSize: 8 },
                                                            headStyles: { fillColor: [60, 179, 113] }
                                                        });
                                                        y = doc.lastAutoTable.finalY + 10;
                                                    });
                                                    
                                                    const nomeFile = `Programma_Completo_${gita.nome.replace(/\s+/g, '_')}_${periodo.replace(/\//g, '-')}.pdf`;
                                                    doc.save(nomeFile);
                                                }
                                                
                                                next(0);
                                            });
                                        });
                  }
                  
                  
                  
                  function formatTitolo(s) {
                      return (s || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                  }
                  
                  
                  function formatTitolo(s) {
                      return (s || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                  }
                  
                  
                  function mostraGita(docId, nomeGita) {
                      currentGitaId = docId;
                      db.collection("utenti").doc(auth.currentUser.email).get().then(doc => {
                          const tipo = doc.data()?.tipo || "Limitato";
                          const email = auth.currentUser.email;
                          
                          const √®Admin = adminEmails.includes(email);
                          
                          if (tipo === "Limitato" && !√®Admin) {
                              // üîí Nasconde tutti i pulsanti tranne "Organizzazione Immersioni", Gite, Indietro, Logout
                              document.querySelectorAll('#sezioniGita .nav-btn').forEach(btn => {
                                  const testo = btn.textContent.toLowerCase();
                                  if (
                                      !testo.includes("organizzazione immersioni") &&
                                      !testo.includes("gite") &&
                                      !testo.includes("indietro") &&
                                      !testo.includes("logout")
                                      ) {
                                          btn.style.display = 'none';
                                      }
                              });
                              
                              // üîΩ Apre direttamente la sezione "Organizzazione Immersione"
                              toggleGitaSection('organizza');
                          } else {
                              // ‚úÖ Per Admin e Completo: mostra tutti i pulsanti
                              document.querySelectorAll('#sezioniGita .nav-btn').forEach(btn => {
                                  btn.style.display = 'inline-block';
                              });
                          }
                      });
                      
                      caricaPartecipantiEsistenti();
                      document.getElementById('sezioniGita').classList.remove('hidden');
                      document.getElementById('titoloGita').textContent = nomeGita;
                      document.getElementById('nomeGita').value = '';
                      document.getElementById('dateGita').value = '';
                      document.getElementById('listaGite').style.display = 'none';
                      document.getElementById('btnArchivio').style.display = 'none';
                      document.getElementById('listaGiteArchivio').style.display = 'none';
                      document.getElementById('apriImpostazioni').style.display = 'none';
                      document.getElementById('bloccoAggiungiGita').style.display = 'none';
                      
                      document.querySelector('#mainApp > div').style.display = 'none';
                      caricaCalendarioTuffi(docId);
                      document.getElementById('sezioniGita').classList.remove('hidden');
                      document.getElementById('nomeGita').value = '';
                      document.getElementById('dateGita').value = '';
                      document.getElementById('listaGite').style.display = 'none';
                      document.querySelector('#mainApp > div').style.display = 'none';
                      document.getElementById('sezioneImbarcazioni').classList.add('hidden');
                      document.getElementById('sezioneTuffi').classList.add('hidden');
                      document.getElementById('sezioneImporta').classList.add('hidden');
                      document.getElementById('sezioneOrganizza').classList.add('hidden');
                      
                      if (!document.getElementById('backToGite')) {
                          const backBtn = document.createElement('button');
                          backBtn.id = 'backToGite';
                          backBtn.textContent = 'Indietro';
                          backBtn.style.background = '#ccc';
                          backBtn.style.marginBottom = '10px';
                          backBtn.onclick = () => {
                              document.getElementById('sezioniGita').classList.add('hidden');
                              document.getElementById('titoloGita').textContent = 'Gite';
                              document.getElementById('listaGite').style.display = 'block';
                              const email = auth.currentUser.email;
                              db.collection("utenti").doc(email).get().then(doc => {
                                  const tipo = doc.data()?.tipo || "Limitato";
                                  
                                  if (adminEmails.includes(email) || tipo === "Completo") {
                                      document.getElementById('bloccoAggiungiGita').style.display = 'block';
                                  } else {
                                      document.getElementById('bloccoAggiungiGita').style.display = 'none';
                                  }
                              });
                              document.querySelector('#mainApp > div').style.display = 'block';
                              document.getElementById('sezioneImpostazioni').style.display = 'none'; // ‚¨ÖÔ∏è CHIUDE la sezione impostazioni
                              // Mostra il pulsante Archivio solo se ci sono gite passate
                              const archivio = document.getElementById('listaGiteArchivio');
                              if (archivio && archivio.childElementCount > 0) {
                                  document.getElementById('btnArchivio').style.display = 'inline-block';
                                  document.getElementById('btnArchivio').textContent = 'üìÅ Archivio'; // üëà AGGIUNTA QUI
                              } else {
                                  document.getElementById('btnArchivio').style.display = 'none';
                              }
                              if (adminEmails.includes(auth.currentUser.email)) {
                                  document.getElementById('apriImpostazioni').style.display = 'inline-block';
                              } else {
                                  document.getElementById('apriImpostazioni').style.display = 'none';
                              }
                              backBtn.remove();
                          };
                          document.getElementById('mainApp').insertBefore(backBtn, document.getElementById('sezioniGita'));
                      }
                      
                  }
                  
                  function aggiungiGita() {
                      const nome = document.getElementById('nomeGita').value.trim();
                      const dateStr = document.getElementById('dateGita').value.trim();
                      if (!nome || !dateStr) {
                          showMsg("Inserisci nome e date della gita");
                          return;
                      }
                      
                      const [startDate, endDate] = dateStr.split(" to ").map(d => new Date(d));
                      if (!startDate || !endDate || isNaN(startDate) || isNaN(endDate)) {
                          showMsg("Formato date non valido");
                          return;
                      }
                      
                      db.collection("gite").get().then(snapshot => {
                          let conflict = false;
                          snapshot.forEach(doc => {
                              const gita = doc.data();
                              if (gita.nome === nome) {
                                  conflict = true;
                                  showMsg("Esiste gi√† una gita con questo nome");
                              } else {
                                  const [esistenteStart, esistenteEnd] = gita.dateRange;
                                  const existingStart = new Date(esistenteStart);
                                  const existingEnd = new Date(esistenteEnd);
                                  if ((startDate <= existingEnd && endDate >= existingStart)) {
                                      conflict = true;
                                      showMsg("Sovrapposizione con un'altra gita");
                                  }
                              }
                          });
                          if (!conflict) {
                              db.collection("gite").add({
                                  nome: nome,
                                  dateRange: [startDate.toISOString(), endDate.toISOString()]
                              }).then(() => {
                                  showMsg("Gita aggiunta con successo");
                                  document.getElementById('nomeGita').value = "";
                                  document.getElementById('dateGita').value = "";
                                  loadGite();
                              }).catch(err => {
                                  console.error("Errore nel salvataggio: ", err);
                                  showMsg("Errore nel salvataggio della gita");
                              });
                          }
                      });
                  }
                  
                  function loadGite() {
                      const lista = document.getElementById('listaGite');
                      const archivio = document.getElementById('listaGiteArchivio');
                      const btnArchivio = document.getElementById('btnArchivio');
                      lista.innerHTML = '';
                      archivio.innerHTML = '';
                      btnArchivio.style.display = 'none';
                      archivio.style.display = 'none';
                      
                      db.collection("gite").get().then(snapshot => {
                          const giteArray = [];
                          snapshot.forEach(doc => {
                              giteArray.push({ id: doc.id, ...doc.data() });
                          });
                          
                          giteArray.sort((a, b) => new Date(a.dateRange[0]) - new Date(b.dateRange[0]));
                          const oggi = new Date();
                          let haGitePassate = false;
                          
                          giteArray.forEach(gita => {
                              const btn = document.createElement('button');
                              btn.className = 'nav-btn';
                              
                              const start = new Date(gita.dateRange[0]);
                              const end = new Date(gita.dateRange[1]);
                              const options = { day: '2-digit', month: 'long', year: 'numeric' };
                              let label = `${start.toLocaleDateString('it-IT', options)}`;
                              if (start.toDateString() !== end.toDateString()) {
                                  if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                                      label = `${start.getDate()}-${end.getDate()} ${start.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}`;
                                  } else {
                                      label = `${start.toLocaleDateString('it-IT', options)} - ${end.toLocaleDateString('it-IT', options)}`;
                                  }
                              }
                              btn.textContent = `${gita.nome} (${label})`;
                              
                              btn.onclick = () => {
                                  mostraGita(gita.id, `${gita.nome} (${label})`);
                                  caricaImbarcazioni();
                              };
                              
                              if (end < oggi) {
                                  btn.style.backgroundColor = '#ccc';
                                  btn.style.color = '#333';
                                  archivio.appendChild(btn);
                                  haGitePassate = true;
                              } else {
                                  lista.appendChild(btn);
                              }
                          });
                          
                          if (haGitePassate) {
                              btnArchivio.style.display = 'inline-block';
                              btnArchivio.onclick = () => {
                                  const visibile = archivio.style.display === 'block';
                                  archivio.style.display = visibile ? 'none' : 'block';
                                  btnArchivio.textContent = visibile ? 'üìÅ Archivio' : 'üìÇ Nascondi Archivio';
                              };
                          }
                      });
                  }
                  
                  async function mostraSelezioneTuffo() {
                      const email = auth.currentUser.email;
                      const √®Admin = adminEmails.includes(email);
                      
                      // üîÅ Reset completo del menu selezione mezzi
                      const menuMezzi = document.getElementById('menuMezzi');
                      if (menuMezzi) {
                          menuMezzi.innerHTML = ''; // svuota tutte le opzioni
                          
                          // aggiunge solo l'opzione iniziale
                          const op0 = document.createElement('option');
                          op0.textContent = '-- Seleziona il Mezzo --';
                          op0.value = '';
                          menuMezzi.appendChild(op0);
                          
                          // nasconde tutte le box dei mezzi
                          document.querySelectorAll('.mezzo-box').forEach(div => div.style.display = 'none');
                          
                          // nasconde anche la sezione con i mezzi gi√† assegnati
                          const boxMezzi = document.getElementById('boxMezziAssegnati');
                          if (boxMezzi) boxMezzi.style.display = 'none';
                      }
                      
                      
                      const isLimitato = await db.collection("utenti").doc(email).get().then(doc => {
                          const tipo = doc.data()?.tipo || "Limitato";
                          return tipo === "Limitato" && !√®Admin;
                      });
                      
                      const val = document.getElementById('menuTuffi').value;
                      document.getElementById('menuTuffi').addEventListener('change', mostraSelezioneTuffo);
                      const [data, orario] = val.split('|');
                      if (!data || !orario) return;
                      
                      const doc = await db.collection('gite').doc(currentGitaId).get();
                      const g = doc.data();
                      const imbarcazioniSnapshot = await db.collection("gite").doc(currentGitaId).collection("imbarcazioni").get();
                      const imbs = imbarcazioniSnapshot.docs.map(doc => doc.data());
                      const org = g.organizzazione || {};
                      const mezziSalvati = org[data]?.[orario] || [];
                      
                      const selectMezzi = document.getElementById('menuMezzi');
                      selectMezzi.innerHTML = '';
                      
                      const op0 = document.createElement('option');
                      op0.textContent = '-- Seleziona il Mezzo --';
                      op0.value = '';
                      selectMezzi.appendChild(op0);
                      
                      mezziSalvati.forEach(m => {
                          const opt = document.createElement('option');
                          opt.value = m.nome;
                          opt.textContent = `${m.nome} (${m.tipo})`;
                          selectMezzi.appendChild(opt);
                      });
                      
                      // Nasconde tutte le sezioni dei mezzi fin da subito
                      const tutteBox = document.querySelectorAll('.mezzo-box');
                      tutteBox.forEach(b => b.style.display = 'none');
                      
                      selectMezzi.onchange = () => {
                          const valore = selectMezzi.value;
                          
                          // Ripristina il bottone "Associa Partecipanti" del mezzo selezionato
                          const mezzoBox = document.querySelector(`.mezzo-box[data-nome="${valore}"]`);
                          if (mezzoBox) {
                              const btn = mezzoBox.querySelector('.btn-associa-partecipanti');
                              if (btn) btn.style.display = 'inline-block';
                          }
                          
                          // Mostra solo il box del mezzo selezionato
                          document.querySelectorAll('.mezzo-box').forEach(div => {
                              div.style.display = (div.dataset.nome === valore) ? 'block' : 'none';
                          });
                          
                          // Mostra/nasconde la sezione "Mezzi gi√† assegnati"
                          const boxMezzi = document.getElementById('boxMezziAssegnati');
                          if (boxMezzi) {
                              boxMezzi.style.display = valore ? 'block' : 'none';
                          }
                          
                          // üî¥ Rimuovi la sezione "Associa Partecipanti" se presente
                          const sezioni = document.querySelectorAll('#organizzazioneImmersioneContainer > .section');
                          sezioni.forEach(sec => {
                              if (sec.querySelector('#btnConfermaPartecipanti')) {
                                  sec.remove();
                              }
                          });
                      };
                      
                      
                      
                      
                      
                      const wrap = document.getElementById('organizzazioneImmersioneContainer');
                      wrap.innerHTML = '';
                      
                      const div = document.createElement('div');
                      
                      
                      const checkboxContainer = document.createElement('div');
                      checkboxContainer.style.display = 'flex';
                      checkboxContainer.style.flexWrap = 'wrap';
                      checkboxContainer.style.gap = '10px';
                      
                      const rivaBox = document.createElement('div');
                      const rivaInput = document.createElement('input');
                      rivaInput.type = 'checkbox';
                      rivaInput.id = 'mezzo-riva';
                      rivaInput.value = 'Da Terra';
                      if (mezziSalvati.some(m => m.nome === 'Da Terra')) rivaInput.checked = true;
                      rivaBox.appendChild(rivaInput);
                      rivaBox.appendChild(document.createTextNode('Immersione da Riva'));
                      checkboxContainer.appendChild(rivaBox);
                      
                      imbs.forEach((imb, i) => {
                          const box = document.createElement('div');
                          const input = document.createElement('input');
                          input.type = 'checkbox';
                          input.id = `mezzo-${i}`;
                          input.value = imb.nome;
                          if (mezziSalvati.some(m => m.nome === imb.nome)) input.checked = true;
                          box.appendChild(input);
                          box.appendChild(document.createTextNode(`${imb.nome} (${imb.tipologia})`));
                          checkboxContainer.appendChild(box);
                      });
                      
                      if (!isLimitato) {
                          div.innerHTML = `<h4>Seleziona mezzi per ${new Date(data).toLocaleDateString('it-IT')} - ${orario}</h4>`;
                          div.appendChild(checkboxContainer); // mostra i checkbox solo se NON limitato
                      }
                      
                      
                      const saveBtn = document.createElement('button');
                      saveBtn.textContent = 'Salva Mezzi Selezionati';
                      saveBtn.onclick = async () => {
                          const selezionati = [];
                          const mezziDaEliminare = [];
                          
                          // Gestione "Da Terra"
                          const eraPresenteRiva = mezziSalvati.find(m => m.nome === 'Da Terra');
                          const rivaSelezionata = rivaInput.checked;
                          
                          if (rivaSelezionata) {
                              selezionati.push({
                                  nome: 'Da Terra',
                                  tipo: 'Riva',
                                  capienza: 9999,
                                  persone: eraPresenteRiva?.persone || []
                              });
                          } else if (eraPresenteRiva?.persone?.length > 0) {
                              mezziDaEliminare.push(`Da Terra (${eraPresenteRiva.persone.length} partecipanti)`);
                          }
                          
                          // Gestione imbarcazioni
                          imbs.forEach((imb, i) => {
                              const el = document.getElementById(`mezzo-${i}`);
                              const gi√† = mezziSalvati.find(m => m.nome === imb.nome);
                              const √®Selezionato = el && el.checked;
                              
                              if (√®Selezionato) {
                                  selezionati.push({
                                      mezzoId: imb.nome,
                                      nome: imb.nome,
                                      tipo: imb.tipologia,
                                      capienza: imb.capienza,
                                      persone: gi√†?.persone || []
                                  });
                              } else if (gi√†?.persone?.length > 0) {
                                  mezziDaEliminare.push(`${imb.nome} (${gi√†.persone.length} partecipanti)`);
                              }
                          });
                          
                          // Conferma eliminazione mezzi con persone
                          if (mezziDaEliminare.length > 0) {
                              const conferma = confirm(
                                                       `Stai per rimuovere i seguenti mezzi che hanno gi√† partecipanti associati:\n\n` +
                                                       mezziDaEliminare.join('\n') +
                                                       `\n\nProcedere comunque?`
                                                       );
                                                       if (!conferma) return;
                          }
                          
                          // Salva
                          const org = g.organizzazione || {};
                          org[data] = org[data] || {};
                          org[data][orario] = selezionati;
                          
                          await db.collection('gite').doc(currentGitaId).update({ organizzazione: org });
                          alert('Organizzazione salvata per il tuffo');
                          mostraSelezioneTuffo();
                      };
                      
                      
                      if (!isLimitato) {
                          div.appendChild(saveBtn);
                      }
                      
                      if (mezziSalvati.length === 0) {
                        const copiaDiv = document.createElement('div');
                        copiaDiv.style.marginTop = '15px';
                        copiaDiv.style.padding = '10px';
                        copiaDiv.style.border = '1px dashed #ccc';
                        copiaDiv.style.backgroundColor = '#f9f9f9';

                        const label = document.createElement('label');
                        label.textContent = "Vuoi copiare in questo Tuffo l'organizzazione di un altro tuffo?";
                        label.style.marginRight = '10px';

                        const switchInput = document.createElement('input');
                        switchInput.type = 'checkbox';

                        copiaDiv.appendChild(label);
                        copiaDiv.appendChild(switchInput);

                        const selectCopia = document.createElement('select');
                        selectCopia.style.display = 'none';
                        selectCopia.style.marginLeft = '10px';

                        const btnConfermaCopia = document.createElement('button');
                        btnConfermaCopia.textContent = "Conferma";
                        btnConfermaCopia.style.display = 'none';
                        btnConfermaCopia.style.marginLeft = '10px';

                        copiaDiv.appendChild(selectCopia);
                        copiaDiv.appendChild(btnConfermaCopia);
                        div.insertBefore(copiaDiv, checkboxContainer);

                        // Carica tuffi con organizzazione
                        const snapshot = await db.collection('gite').doc(currentGitaId).get();
                        const dati = snapshot.data();
                        const organizzazione = dati.organizzazione || {};
                        const opzioniDisponibili = [];

                        for (const dataT in organizzazione) {
                          for (const oraT in organizzazione[dataT]) {
                            if (organizzazione[dataT][oraT].length > 0 && !(dataT === data && oraT === orario)) {
                              opzioniDisponibili.push({ data: dataT, orario: oraT });
                            }
                          }
                        }

                        opzioniDisponibili.forEach(opt => {
                          const o = document.createElement('option');
                          o.value = `${opt.data}|${opt.orario}`;
                          o.textContent = `${new Date(opt.data).toLocaleDateString('it-IT')} - ${opt.orario}`;
                          selectCopia.appendChild(o);
                        });

                        switchInput.onchange = () => {
                          const visible = switchInput.checked;
                          selectCopia.style.display = visible ? 'inline-block' : 'none';
                          btnConfermaCopia.style.display = visible ? 'inline-block' : 'none';
                        };

                        btnConfermaCopia.onclick = async () => {
                          const selezione = selectCopia.value;
                          if (!selezione) return alert("Seleziona un tuffo da cui copiare.");
                          const [fromData, fromOra] = selezione.split('|');
                          const daCopiare = organizzazione[fromData]?.[fromOra];
                          if (!daCopiare) return alert("Organizzazione non trovata.");

                          const docCorrente = await db.collection("gite").doc(currentGitaId).get();
                          const gita = docCorrente.data();
                          const org = gita.organizzazione || {};
                          org[data] = org[data] || {};
                          org[data][orario] = JSON.parse(JSON.stringify(daCopiare)); // copia profonda

                          await db.collection("gite").doc(currentGitaId).update({ organizzazione: org });
                          alert("Organizzazione copiata nel tuffo selezionato.");

                          // üîÅ Seconda domanda
                          const altraDomanda = document.createElement('div');
                          altraDomanda.style.marginTop = '10px';
                          altraDomanda.innerHTML = `<strong>Vuoi riempire anche gli altri tuffi non assegnati con la stessa organizzazione?</strong><br>`;

                          const btnNo = document.createElement('button');
                          btnNo.textContent = "No";
                          btnNo.style.marginRight = '10px';

                          const btnSi = document.createElement('button');
                          btnSi.textContent = "S√¨";

                          altraDomanda.appendChild(btnNo);
                          altraDomanda.appendChild(btnSi);
                          copiaDiv.appendChild(altraDomanda);

                          btnNo.onclick = () => {
                            mostraSelezioneTuffo(); // ricarica la sezione
                          };

                          btnSi.onclick = async () => {
                            const snapshot2 = await db.collection("gite").doc(currentGitaId).get();
                            const gita2 = snapshot2.data();
                            const org2 = gita2.organizzazione || {};
                            let copiati = 0;

                            for (const d in org2) {
                              for (const o of Object.keys(org2[d])) {
                                if (!org2[d][o] || org2[d][o].length === 0) {
                                  org2[d][o] = JSON.parse(JSON.stringify(daCopiare));
                                  copiati++;
                                }
                              }
                            }

                            await db.collection("gite").doc(currentGitaId).update({ organizzazione: org2 });
                            alert(`Organizzazione copiata in ${copiati} tuffi vuoti.`);
                            mostraSelezioneTuffo(); // torna alla schermata aggiornata
                          };
                        };
                      }

                      
                      if (mezziSalvati.length > 0) {
                          
                          const elenco = document.createElement('div');
                          elenco.id = 'boxMezziAssegnati';
                          elenco.style.display = 'none'; // Nascondi all'inizio
                          mezziSalvati.forEach(mezzo => {
                              const box = document.createElement('div');
                              box.className = 'mezzo-box';
                              box.dataset.nome = mezzo.nome;
                              const occupati = mezzo.persone?.length || 0;
                              const cap = mezzo.capienza;
                              const residui = (cap === undefined) ? '‚àû' : Math.max(cap - occupati, 0);
                              
                              const titolo = document.createElement('strong');
                              
                              titolo.textContent = `${mezzo.nome} (${mezzo.tipo}) ‚Äî `
                              + (cap !== undefined ? `${occupati}/${cap}` : `${occupati}`)
                              + ` partecipanti  |  posti residui: ${residui}`;
                              
                              box.appendChild(titolo);
                              div.appendChild(elenco);  // appendilo solo una volta
                              
                              // Campo Punto Immersione (caricato da mezzo.punto se esiste)
                              // Input Punto Immersione
                              const puntoInput = document.createElement('input');
                              puntoInput.type = 'text';
                              puntoInput.placeholder = 'Punto di immersione';
                              puntoInput.style.marginLeft = '10px'
                              puntoInput.style.marginRight = '10px';
                              puntoInput.style.flex = '1 1 200px';
                              puntoInput.value = mezzo.punto || '';
                              
                              // Input Profondit√† Massima
                              const profonditaInput = document.createElement('input');
                              profonditaInput.type = 'number';
                              profonditaInput.placeholder = 'Profondit√† Max (m)';
                              profonditaInput.min = 1;
                              profonditaInput.style.marginRight = '10px';
                              profonditaInput.style.marginLeft = '10px';
                              profonditaInput.style.width = '140px';
                              profonditaInput.value = mezzo.profondita || '';
                              
                              // Bottone Salva
                              const btnSalvaPunto = document.createElement('button');
                              btnSalvaPunto.textContent = 'Salva Punto e Profondit√† Immersione';
                              btnSalvaPunto.style.marginLeft = '10px';
                              
                              // Salvataggio in Firebase
                              btnSalvaPunto.onclick = async () => {
                                  const doc = await db.collection('gite').doc(currentGitaId).get();
                                  const gita = doc.data();
                                  const val = document.getElementById('menuTuffi').value;
                                  const [giorno, orario] = val.split('|');
                                  
                                  const organizzazione = gita.organizzazione || {};
                                  if (!organizzazione[giorno] || !organizzazione[giorno][orario]) return;
                                  
                                  const mezzi = organizzazione[giorno][orario];
                                  const m = mezzi.find(m => m.nome === mezzo.nome);
                                  if (m) {
                                      m.punto = puntoInput.value.trim();
                                      m.profondita = parseInt(profonditaInput.value.trim()) || null;
                                      
                                      // ‚úÖ aggiorna l'oggetto `mezzo` corrente con la nuova profondit√†
                                      mezzo.punto = m.punto;
                                      mezzo.profondita = m.profondita;
                                      
                                      await db.collection('gite').doc(currentGitaId).update({ organizzazione });
                                      alert('Punto e profondit√† salvati.');
                                  }
                              };
                              
                              if (!isLimitato) {
                                  box.appendChild(puntoInput);
                                  box.appendChild(profonditaInput);
                                  box.appendChild(btnSalvaPunto);
                              }
                              
                              
                              
                              if (mezzo.persone && mezzo.persone.length > 0) {
                                  const wrapperTabella = document.createElement('div');
                                  wrapperTabella.className = 'table-responsive';
                                  
                                  const tabella = document.createElement('table');
                                  tabella.style.marginTop = '10px';
                                  tabella.style.borderCollapse = 'collapse';
                                  tabella.innerHTML = `
                    <thead>
                      <tr>
                        <th style="width: 40px;"></th>
                        <th style="min-width: 180px;">Nome</th>
                        <th style="min-width: 120px;">Corso</th>
                        <th style="min-width: 120px;">Categoria</th>
                      </tr>
                    </thead>
                    <tbody id="tbody_${mezzo.nome.replace(/\s+/g, '_')}"></tbody>
                  `;
                  
                  const tbody = tabella.querySelector('tbody');
                  
                  mezzo.persone.forEach(p => {
                      const nome = typeof p === "string" ? p : p.nome;
                      const corso = typeof p === "object" ? (p.corso || '') : '';
                      const categoria = typeof p === "object" ? (p.categoria || '') : '';
                      const statoPresenza = (g.presenze?.[nome]?.[`${data}|${orario}`]) ?? true;
                      
                      const tr = document.createElement('tr');
                      const tdCheck = document.createElement('td');
                      const checkbox = document.createElement('input');
                      checkbox.type = 'checkbox';
                      checkbox.className = 'chkPresenza';
                      checkbox.dataset.nome = nome;
                      checkbox.checked = statoPresenza;
                      
                      tdCheck.appendChild(checkbox);
                      const tdNome = document.createElement('td');
                      const tdCorso = document.createElement('td');
                      const tdCategoria = document.createElement('td');
                      
                      tdNome.textContent = nome;
                      if (g.presenze?.[nome]?.[`${data}|${orario}`] !== undefined) {
                          tdNome.style.color = statoPresenza ? 'green' : 'red';
                      } else {
                          tdNome.style.color = 'black'; // colore neutro di default
                      }
                      tdCorso.textContent = corso;
                      tdCategoria.textContent = categoria;
                      
                      tr.appendChild(tdCheck);
                      tr.appendChild(tdNome);
                      tr.appendChild(tdCorso);
                      tr.appendChild(tdCategoria);
                      
                      tbody.appendChild(tr);
                  });
                  
                  wrapperTabella.appendChild(tabella);
                  box.appendChild(wrapperTabella);
                  
                  // Pulsante per salvare le presenze in blocco
                  const salvaPresenzeBtn = document.createElement('button');
                  salvaPresenzeBtn.textContent = 'Salva Presenze';
                  salvaPresenzeBtn.style.marginTop = '10px';
                  salvaPresenzeBtn.style.backgroundColor = '#28a745';  // verde
                  salvaPresenzeBtn.style.color = 'white';
                  salvaPresenzeBtn.onclick = async () => {
                      const checkboxes = box.querySelectorAll('.chkPresenza');
                      const aggiornamenti = {};
                      
                      checkboxes.forEach(chk => {
                          const nome = chk.dataset.nome;
                          const key = `presenze.${nome}.${data}|${orario}`;
                          aggiornamenti[key] = chk.checked;
                      });
                      
                      await db.collection('gite').doc(currentGitaId).update(aggiornamenti);
                      checkboxes.forEach(chk => {
                          const td = chk.closest('tr')?.querySelector('td:nth-child(2)');
                          if (td) {
                              td.style.color = chk.checked ? 'green' : 'red';
                          }
                      });
                      
                      alert('Presenze salvate correttamente');
                  };
                  
                  box.appendChild(salvaPresenzeBtn);
                              }
                              
                              
                              
                              if (!isLimitato) {
                                  const btnAssoc = document.createElement('button');
                                  btnAssoc.textContent = 'Associa Partecipanti';
                                  btnAssoc.style.marginTop = '10px';
                                  btnAssoc.style.marginLeft = '10px';
                                  btnAssoc.classList.add('btn-associa-partecipanti');
                                  btnAssoc.onclick = () => {
                                      mostraFiltroPartecipanti(mezzo.nome);
                                      btnAssoc.style.display = 'none';
                                  };
                                  box.appendChild(btnAssoc);
                              }
                              
                              
                              
                              const bottoneFoglioBarca = document.createElement('button');
                              bottoneFoglioBarca.textContent = 'Scarica foglio barca';
                              bottoneFoglioBarca.style.marginTop = '10px';
                              bottoneFoglioBarca.style.marginLeft = '10px';
                              bottoneFoglioBarca.style.backgroundColor = "#007bff";
                              bottoneFoglioBarca.style.color = "white";
                              bottoneFoglioBarca.onclick = async () => {
                                  const conferma = confirm("Vuoi generare il PDF del Foglio Barca?");
                                  if (!conferma) return;
                                  
                                  const val = document.getElementById('menuTuffi').value;
                                  const [giorno, orario] = val.split('|');
                                  if (!giorno || !orario) {
                                      alert('Seleziona prima un tuffo');
                                      return;
                                  }
                                  
                                  const doc = await db.collection('gite').doc(currentGitaId).get();
                                  const dati = doc.data();
                                  const listaCompletaPartecipanti = dati.partecipanti || [];
                                  const mezzoSalvato = dati.organizzazione?.[giorno]?.[orario]?.find(m => m.nome === mezzo.nome);
                                  
                                  if (!mezzoSalvato) {
                                      alert("Mezzo non trovato nell'organizzazione.");
                                      return;
                                  }
                                  
                                  generaFoglioBarcaPDF({
                                      giorno,
                                      orario,
                                      mezzo,
                                      partecipanti: mezzo.persone || [],
                                      partecipantiTotali: listaCompletaPartecipanti,
                                      nomeGita: dati.nome,
                                      puntoImmersione: mezzo.punto || '',
                                      ProfImmersione: mezzo.profondita || '',
                                      // ‚Üê legge dal dato aggiornato in Firebase
                                  });
                              };
                              
                              box.appendChild(bottoneFoglioBarca);
                              
                              elenco.appendChild(box);
                              
                          });
                          div.appendChild(elenco);
                      }
                      
                      wrap.appendChild(div);
                  }
                  
                  
                  function aggiungiImbarcazione() {
                      const nome = document.getElementById('nomeImbarcazione').value.trim();
                      const capienza = parseInt(document.getElementById('capienzaImbarcazione').value);
                      const tipologia = document.getElementById('tipologiaImbarcazione').value;
                      if (!nome || isNaN(capienza) || capienza <= 0) {
                          showMsg("Compila correttamente tutti i campi dell'imbarcazione.");
                          return;
                      }
                      const gitaRef = db.collection("gite").where("nome", "==", document.getElementById('titoloGita').textContent.split(' (')[0]);
                      gitaRef.get().then(querySnapshot => {
                          if (!querySnapshot.empty) {
                              const docId = querySnapshot.docs[0].id;
                              db.collection("gite").doc(docId).collection("imbarcazioni").where("nome", "==", nome).get().then(snapshot => {
                                  if (!snapshot.empty) {
                                      showMsg("Esiste gi√† una imbarcazione con questo nome.");
                                      return;
                                  }
                                  db.collection("gite").doc(docId).collection("imbarcazioni").add({ nome, capienza, tipologia })
                                  .then(() => {
                                      showMsg("Imbarcazione aggiunta.");
                                      document.getElementById('nomeImbarcazione').value = '';
                                      document.getElementById('capienzaImbarcazione').value = '';
                                      caricaImbarcazioni();
                                  });
                              });
                          }
                      });
                  }
                  function formatTitolo(s) {
                      return (s || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                  }
                  
                  function generaFoglioBarcaPDF({ giorno, orario, mezzo, partecipanti, partecipantiTotali, nomeGita, puntoImmersione, ProfImmersione }) {
                      const { jsPDF } = window.jspdf;
                      const doc = new jsPDF();
                      
                      const logoUrls = [
                                        "https://res.cloudinary.com/mymagazzino/image/upload/v1748814243/Loghi%20App/bmyvpktpv2jni4f4ocvp.png",
                                        "https://res.cloudinary.com/mymagazzino/image/upload/v1748973122/Loghi%20App/sespy19fmpgp5xakdgyz.png"
                                        ];
                                        
                                        const logoY = 5;
                                        const targetHeight = 25;
                                        const spacing = 10;
                                        const imagesToInsert = [];
                                        let loaded = 0;
                                        
                                        logoUrls.forEach((url, index) => {
                                            fetch(url)
                                            .then(res => res.blob())
                                            .then(blob => new Promise(resolve => {
                                                const reader = new FileReader();
                                                reader.onloadend = () => resolve(reader.result);
                                                reader.readAsDataURL(blob);
                                            }))
                                            .then(base64 => {
                                                const img = new Image();
                                                img.onload = () => {
                                                    const aspect = img.width / img.height;
                                                    const width = targetHeight * aspect;
                                                    imagesToInsert[index] = { base64, width };
                                                    loaded++;
                                                    if (loaded === logoUrls.length) {
                                                        const totalWidth = imagesToInsert.reduce((sum, el) => sum + el.width, 0) + spacing * (imagesToInsert.length - 1);
                                                        const startX = (doc.internal.pageSize.getWidth() - totalWidth) / 2;
                                                        let x = startX;
                                                        imagesToInsert.forEach(({ base64, width }) => {
                                                            doc.addImage(base64, 'PNG', x, logoY, width, targetHeight);
                                                            x += width + spacing;
                                                        });
                                                        continuaGenerazionePDF();
                                                    }
                                                };
                                                img.src = base64;
                                            });
                                        });
                                        
                                        function formatTitolo(s) {
                                            return (s || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                                        }
                                        
                                        function continuaGenerazionePDF() {
                                            let y = logoY + targetHeight + 10;
                                            
                                            const corsiSet = new Set();
                                            const staff = [], utenti = [];
                                            
                                            partecipanti.forEach(pItem => {
                                                const nome = typeof pItem === "string" ? pItem : pItem.nome;
                                                const pGlobale = partecipantiTotali.find(x => x.nome === nome);
                                                
                                                const corso = typeof pItem === "object" ? (pItem.corso || pGlobale?.corso || '') : (pGlobale?.corso || '');
                                                const categoria = typeof pItem === "object" ? (pItem.categoria || pGlobale?.categoria || '') : (pGlobale?.categoria || '');
                                                
                                                const catLower = (categoria || '').toLowerCase();
                                                const isStaff = ['istruttore', 'aiutoistruttore', 'divemaster'].includes(catLower);
                                                
                                                const obj = {
                                                    nome,
                                                    corso,
                                                    categoria
                                                };
                                                
                                                corsiSet.add(corso || 'Nessun corso');
                                                isStaff ? staff.push(obj) : utenti.push(obj);
                                            });
                                            
                                            
                                            const corsi = Array.from(corsiSet).filter(Boolean).join(" e ") || 'Nessun corso';
                                            const profStr = mezzo.profondita ? ` Profondit√† Massima ${mezzo.profondita} metri` : '';
                                            const titolo = `${mezzo.nome} (${mezzo.tipo}) - ${profStr || '?'} `;
                                            
                                            utenti.sort((a, b) => {
                                                const corsoA = a.corso.toLowerCase();
                                                const corsoB = b.corso.toLowerCase();
                                                if (corsoA < corsoB) return -1;
                                                if (corsoA > corsoB) return 1;
                                                return a.nome.localeCompare(b.nome);
                                            });
                                            
                                            function categoriaPriorita(cat) {
                                                switch (cat.toLowerCase()) {
                                                    case 'istruttore': return 0;
                                                    case 'aiutoistruttore': return 1;
                                                    case 'divemaster': return 2;
                                                    default: return 3;
                                                }
                                            }
                                            
                                            staff.sort((a, b) => {
                                                const corsoA = a.corso.toLowerCase();
                                                const corsoB = b.corso.toLowerCase();
                                                if (corsoA < corsoB) return -1;
                                                if (corsoA > corsoB) return 1;
                                                const pA = categoriaPriorita(a.categoria);
                                                const pB = categoriaPriorita(b.categoria);
                                                if (pA !== pB) return pA - pB;
                                                return a.nome.localeCompare(b.nome);
                                            });
                                            
                                            const dataLabel = new Date(giorno).toLocaleDateString('it-IT');
                                            const nomeFile = `${mezzo.nome.replace(/\s+/g, '_')}_${dataLabel.replace(/\//g, '-')}_${orario.replace(':', '')}.pdf`;
                                            
                                            doc.setFontSize(14);
                                            doc.text(titolo, 10, y);
                                            y += 8;
                                            
                                            doc.setFontSize(11);
                                            doc.text(`GITA: ${nomeGita}`, 10, y); y += 6;
                                            if (puntoImmersione) {
                                                doc.text(`PUNTO IMMERSIONE: ${puntoImmersione}`, 10, y); y += 6;
                                            }
                                            doc.text(`DATA: ${dataLabel}`, 10, y); y += 6;
                                            doc.text(`ORARIO: ${orario}`, 10, y); y += 6;
                                            doc.text(`POSTI BARCA: ${mezzo.capienza || '‚àû'}`, 10, y);
                                            doc.text(`SUBACQUEI A BORDO: ${partecipanti.length}`, 100, y);
                                            y += 10;
                                            
                                            const tableOpts = {
                                                theme: 'grid',
                                                styles: { fontSize: 10 },
                                                headStyles: { fillColor: [0, 123, 255] },
                                                margin: { left: 10, right: 10 }
                                            };
                                            
                                            if (utenti.length) {
                                                doc.text('ALLIEVI', 10, y);
                                                y += 6;
                                                doc.autoTable({
                                                    ...tableOpts,
                                                    startY: y,
                                                    head: [['#', 'Nome', 'Corso', 'Categoria']],
                                                    body: utenti.map((p, i) => [
                                                                                i + 1,
                                                                                formatTitolo(p.nome),
                                                                                formatTitolo(p.corso),
                                                                                formatTitolo(p.categoria)
                                                                                ])
                                                });
                                                y = doc.lastAutoTable.finalY + 10;
                                            }
                                            
                                            if (staff.length) {
                                                doc.text('STAFF', 10, y);
                                                y += 6;
                                                doc.autoTable({
                                                    ...tableOpts,
                                                    startY: y,
                                                    head: [['#', 'Nome', 'Corso', 'Categoria']],
                                                    body: staff.map((p, i) => [
                                                                               i + 1,
                                                                               formatTitolo(p.nome),
                                                                               formatTitolo(p.corso),
                                                                               formatTitolo(p.categoria)
                                                                               ])
                                                });
                                            }
                                            
                                            doc.save(nomeFile);
                                        }
                  }
                  
                  async function salvaPartecipantiMezzo(mezzoNome, nomeSelezionato) {
                      const doc = await db.collection('gite').doc(currentGitaId).get();
                      const g = doc.data();
                      const val = document.getElementById('menuTuffi').value;
                      const [data, orario] = val.split('|');
                      
                      const org = g.organizzazione || {};
                      if (!org[data] || !org[data][orario]) return;
                      
                      const mezzi = org[data][orario];
                      const mezziAltri = mezzi.filter(m => m.nome !== mezzoNome);
                      const giaAssegnati = new Set();
                      mezziAltri.forEach(m => (m.persone || []).forEach(p => giaAssegnati.add(p)));
                      
                      if (giaAssegnati.has(nomeSelezionato)) {
                          alert(`Attenzione: il partecipante ${nomeSelezionato} √® gi√† assegnato ad un altro mezzo nello stesso tuffo.`);
                          return;
                      }
                      
                      const mezzo = mezzi.find(m => m.nome === mezzoNome);
                      if (mezzo) {
                          mezzo.persone = mezzo.persone || [];
                          if (mezzo.capienza !== undefined && mezzo.persone.length >= mezzo.capienza) {
                              alert(`La capienza massima per ${mezzo.nome} √® ${mezzo.capienza}.`);
                              return;
                          }
                          if (!mezzo.persone.includes(nomeSelezionato)) {
                              mezzo.persone.push({ nome: nomeSelezionato, corso: "...", categoria: "..." });
                          }
                      }
                      
                      await db.collection('gite').doc(currentGitaId).update({ organizzazione: org });
                      mostraSelezioneTuffo();
                  }
                  
                  async function rimuoviPartecipanteDaMezzo(mezzoNome, nomePartecipante) {
                      const doc = await db.collection('gite').doc(currentGitaId).get();
                      const g = doc.data();
                      const val = document.getElementById('menuTuffi').value;
                      const [data, orario] = val.split('|');
                      
                      const org = g.organizzazione || {};
                      if (!org[data] || !org[data][orario]) return;
                      
                      const mezzo = org[data][orario].find(m => m.nome === mezzoNome);
                      if (mezzo && mezzo.persone) {
                          mezzo.persone = mezzo.persone.filter(p => p !== nomePartecipante);
                      }
                      
                      await db.collection('gite').doc(currentGitaId).update({ organizzazione: org });
                      mostraSelezioneTuffo();
                  }
                  
                  let partecipantiAssegnati = [];
                  let partecipantiSelezionatiTemp = new Set();
                  
                  function mostraFiltroPartecipanti(mezzoNome) {
                      partecipantiSelezionatiTemp = new Set();
                      const container = document.createElement('div');
                      container.className = 'section';
                      container.innerHTML = `
                  <h5>Seleziona Partecipanti per ${mezzoNome}</h5>
                  <label>Corso:</label>
                  <select id="filtroCorso"></select>
                  <label>Categoria:</label>
                  <select id="filtroCategoria"></select>
                
                  <!--  ‚úÖ  Nuovi pulsanti  -->
                  <button id="btnSelezionaTutti">Seleziona tutti</button>
                  <button id="btnDeselezionaTutti">Deseleziona tutti</button>
                
                  <div id="checklistPartecipanti"></div>
                  <button id="btnConfermaPartecipanti">Conferma Associazione</button>
                  <p id="conteggioSelezionati"></p>
                `;
                
                document.getElementById('organizzazioneImmersioneContainer').appendChild(container);
                
                document.getElementById('btnConfermaPartecipanti').addEventListener('click', () => salvaSelezioneMultipla(mezzoNome));
                //  Seleziona tutti i check-box abilitati
                document.getElementById('btnSelezionaTutti').onclick = () => {
                    document.querySelectorAll('#checklistPartecipanti input[type="checkbox"]:not([disabled])')
                    .forEach(chk => {
                        chk.checked = true;                     // 1Ô∏è‚É£ spunta
                        partecipantiSelezionatiTemp.add(chk.value); // 2Ô∏è‚É£ memorizza
                    });
                    aggiornaConteggioSelezionati();                  // 3Ô∏è‚É£ aggiorna badge
                };
                
                //  Deseleziona tutti i check-box abilitati
                document.getElementById('btnDeselezionaTutti')
                .addEventListener('click', () => {
                    document.querySelectorAll('#checklistPartecipanti input[type="checkbox"]:not(:disabled)')
                    .forEach(chk => {
                        chk.checked = false;
                        partecipantiSelezionatiTemp.delete(chk.value);
                    });
                    aggiornaConteggioSelezionati();
                });
                
                
                db.collection('gite').doc(currentGitaId).get().then(doc => {
                    window.organizzazioneCache = doc.data().organizzazione || {};
                    const data = doc.data();
                    window.partecipanti = data.partecipanti || [];
                    const val = document.getElementById('menuTuffi').value;
                    const [dataTuffo, orario] = val.split('|');
                    const org = data.organizzazione || {};
                    const mezzo = (org[dataTuffo] && org[dataTuffo][orario] || []).find(m => m.nome === mezzoNome);
                    partecipantiAssegnati = mezzo?.persone || [];
                    partecipantiAssegnati.forEach(p =>
                                                  partecipantiSelezionatiTemp.add(typeof p === 'string' ? p : p.nome)
                                                  );
                                                  
                                                  initFiltri();
                                                  filtraPartecipanti(mezzoNome);
                });
                  }
                  
                  function initFiltri() {
                      const corsoSelect = document.getElementById('filtroCorso');
                      const categoriaSelect = document.getElementById('filtroCategoria');
                      
                      corsoSelect.addEventListener('change', () => filtraPartecipanti());
                      categoriaSelect.addEventListener('change', () => filtraPartecipanti());
                      
                      
                      aggiornaOpzioniFiltri();
                  }
                  
                  function aggiornaOpzioniFiltri() {
                      const corsoSelect = document.getElementById('filtroCorso');
                      const categoriaSelect = document.getElementById('filtroCategoria');
                      const corsoSelezionato = corsoSelect.value;
                      const categoriaSelezionata = categoriaSelect.value;
                      const partecipanti = window.partecipanti || [];
                      
                      const corsi = [...new Set(partecipanti
                                                .filter(p => !categoriaSelezionata || p.categoria?.toLowerCase() === categoriaSelezionata)
                                                .map(p => p.corso || ''))].sort();
                                                const categorie = [...new Set(partecipanti
                                                                              .filter(p => !corsoSelezionato || p.corso === corsoSelezionato)
                                                                              .map(p => p.categoria?.toLowerCase() || ''))].sort();
                                                                              
                                                                              corsoSelect.innerHTML = '<option value="">-- Tutti --</option>';
                                                                              corsi.forEach(c => {
                                                                                  const opt = document.createElement('option');
                                                                                  opt.value = c;
                                                                                  opt.textContent = c || 'Nessun corso';
                                                                                  if (c === corsoSelezionato) opt.selected = true;
                                                                                  corsoSelect.appendChild(opt);
                                                                              });
                                                                              
                                                                              categoriaSelect.innerHTML = '<option value="">-- Tutte --</option>';
                                                                              categorie.forEach(cat => {
                                                                                  if (cat) {
                                                                                      const opt = document.createElement('option');
                                                                                      opt.value = cat;
                                                                                      opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                                                                                      if (cat === categoriaSelezionata) opt.selected = true;
                                                                                      categoriaSelect.appendChild(opt);
                                                                                  }
                                                                              });
                  }
                  
                  function filtraPartecipanti(mezzoNome) {
                      aggiornaOpzioniFiltri();
                      
                      const corso = document.getElementById('filtroCorso').value;
                      const categoria = document.getElementById('filtroCategoria').value;
                      const partecipanti = window.partecipanti || [];
                      const lista = document.getElementById('checklistPartecipanti');
                      lista.innerHTML = '';
                      
                      const filtrati = partecipanti.filter(p =>
                                                           (!corso || p.corso === corso) &&
                                                           (!categoria || p.categoria?.toLowerCase() === categoria)
                                                           );
                                                           
                                                           filtrati.sort((a, b) => {
                                                               const staff = ['istruttore','aiutoistruttore','divemaster'];
                                                               const catA = staff.includes(a.categoria?.toLowerCase()) ? 0 : 1;
                                                               const catB = staff.includes(b.categoria?.toLowerCase()) ? 0 : 1;
                                                               if (catA !== catB) return catA - catB;
                                                               if (a.corso !== b.corso) return (a.corso || '').localeCompare(b.corso || '');
                                                               return a.nome.localeCompare(b.nome);
                                                           });
                                                           
                                                           filtrati.forEach((p, i) => {
                                                               const div = document.createElement('div');
                                                               div.className = 'checklist-item';
                                                               const chk = document.createElement('input');
                                                               chk.type = 'checkbox';
                                                               chk.id = `p_${i}`;
                                                               chk.value = p.nome;
                                                               
                                                               const giaAssegnati = new Set();
                                                               const val = document.getElementById('menuTuffi').value;
                                                               const [data, orario] = val.split('|');
                                                               const gite = window.organizzazioneCache || {};
                                                               const mezziTuffo = (gite[data] && gite[data][orario]) || [];
                                                               mezziTuffo.forEach(m => {
                                                                   if (m.nome !== mezzoNome) {
                                                                       (m.persone || []).forEach(x => {
                                                                           const nomeX = typeof x === 'string' ? x : x.nome;
                                                                           if (!partecipantiAssegnati.includes(p.nome) && nomeX === p.nome) {
                                                                               giaAssegnati.add(p.nome);
                                                                           }
                                                                       });
                                                                   }
                                                               });
                                                               
                                                               
                                                               if (partecipantiSelezionatiTemp.has(p.nome)) chk.checked = true;
                                                               if (giaAssegnati.has(p.nome)) {
                                                                   chk.disabled = true;
                                                                   div.appendChild(document.createTextNode(`${p.nome} (gi√† assegnato)`));
                                                               } else {
                                                                   chk.addEventListener('change', () => {
                                                                       if (chk.checked) partecipantiSelezionatiTemp.add(p.nome);
                                                                       else partecipantiSelezionatiTemp.delete(p.nome);
                                                                       aggiornaConteggioSelezionati();
                                                                   });
                                                                   div.appendChild(chk);
                                                                   div.appendChild(chk);               // ‚ë† il checkbox
                                                                   
                                                                   /* ‚ë° ‚Äì Nome */
                                                                   const lbl = document.createElement('span');
                                                                   lbl.textContent = p.nome;
                                                                   lbl.style.minWidth = '160px';
                                                                   div.appendChild(lbl);
                                                                   
                                                                   /* ‚ë¢ ‚Äì Dropdown CATEGORIA */
                                                                   const catSel = document.createElement('select');
                                                                   catSel.className = 'catSelect';
                                                                   catSel.dataset.nome = p.nome;
                                                                   ['allievo', 'sub', 'istruttore', 'aiutoIstruttore', 'divemaster']
                                                                   .forEach(cat => {
                                                                       const o = new Option(cat, cat);
                                                                       if ((p.categoria || '').toLowerCase() === cat.toLowerCase()) o.selected = true;
                                                                       catSel.appendChild(o);
                                                                   });
                                                                   div.appendChild(catSel);
                                                                   
                                                                   /* ‚ë£ ‚Äì Dropdown / input CORSO  */
                                                                   
                                                                   const courseSel = document.createElement('select');
                                                                   courseSel.className  = 'courseSelect';
                                                                   courseSel.dataset.nome = p.nome;
                                                                   
                                                                   const corsiUnici = [...new Set(window.partecipanti.map(x => x.corso).filter(Boolean))].sort();
                                                                   
                                                                   /* 1 ‚Äì Corsi gi√† presenti */
                                                                   corsiUnici.forEach(c => {
                                                                       // quarto argomento === true ‚Üí opzione preselezionata
                                                                       const opt = new Option(c, c, false, c === p.corso);
                                                                       courseSel.add(opt);
                                                                   });
                                                                   
                                                                   /* 2 ‚Äì Opzione ‚ÄúAltro‚Ä¶‚Äù */
                                                                   courseSel.add(new Option('Altro‚Ä¶', '__altro__', false, !p.corso));
                                                                   
                                                                   /* 3 ‚Äì Se il partecipante ha un corso NON presente tra quelli unici,
                                                                    lo inseriamo in testa e lo facciamo risultare selezionato       */
                                                                   if (p.corso && !corsiUnici.includes(p.corso)) {
                                                                       courseSel.insertBefore(new Option(p.corso, p.corso, false, true), courseSel.firstChild);
                                                                   }
                                                                   
                                                                   courseSel.addEventListener('change', function () {
                                                                       if (this.value === '__altro__') {
                                                                           const inp = document.createElement('input');
                                                                           inp.type = 'text';
                                                                           inp.placeholder = 'Nuovo corso‚Ä¶';
                                                                           inp.className = 'courseInput';
                                                                           inp.dataset.nome = p.nome;
                                                                           this.replaceWith(inp);
                                                                           inp.focus();
                                                                       }
                                                                   });
                                                                   
                                                                   div.appendChild(courseSel);
                                                                   
                                                               }
                                                               lista.appendChild(div);
                                                           });
                                                           
                                                           aggiornaConteggioSelezionati();
                                                           
                  }
                  
                  function aggiornaConteggioSelezionati() {
                      const sel = partecipantiSelezionatiTemp.size;
                      const cap = window.capienzaCorrenteMezzo;
                      const residui = (cap === undefined) ? '‚àû' : Math.max(cap - sel, 0);
                      const testo = `${sel} partecipanti selezionati` +
                      (cap !== undefined ? ` ‚Äî posti residui: ${residui}` : '');
                      document.getElementById('conteggioSelezionati').textContent = testo;
                      
                  }
                  
                  
                  async function salvaSelezioneMultipla(mezzoNome) {
                      const doc = await db.collection('gite').doc(currentGitaId).get();
                      const g = doc.data();
                      const val = document.getElementById('menuTuffi').value;
                      const [data, orario] = val.split('|');
                      const nomi = Array.from(partecipantiSelezionatiTemp);
                      const org = g.organizzazione || {};
                      if (!org[data] || !org[data][orario]) return;
                      
                      const mezzi = org[data][orario];
                      const mezzo = mezzi.find(m => m.nome === mezzoNome);
                      const giaAssegnati = new Set();
                      mezzi.filter(m => m.nome !== mezzoNome).forEach(m => (m.persone || []).forEach(p => giaAssegnati.add(p)));
                      
                      const doppi = nomi.filter(n => giaAssegnati.has(n));
                      if (doppi.length > 0) {
                          alert("I seguenti partecipanti sono gi√† assegnati a un altro mezzo nello stesso tuffo:\n" + doppi.join("\n"));
                          return;
                      }
                      
                      if (mezzo.capienza !== undefined && nomi.length > mezzo.capienza) {
                          alert(`La capienza massima per ${mezzo.nome} √® ${mezzo.capienza}.`);
                          return;
                      }
                      
                      mezzo.persone = nomi.map(nome => {
                          const selCat = document.querySelector(`select.catSelect[data-nome="${nome}"]`);
                          const categoria = selCat ? selCat.value.trim() : '';
                          
                          let corso = '';
                          const inpCorso = document.querySelector(`input.courseInput[data-nome="${nome}"]`);
                          const selCorso = document.querySelector(`select.courseSelect[data-nome="${nome}"]`);
                          if (inpCorso) corso = inpCorso.value.trim();
                          else if (selCorso && selCorso.value !== '__altro__') corso = selCorso.value.trim();
                          
                          return { nome, corso, categoria };
                      });
                      
                      
                      await db.collection('gite').doc(currentGitaId).update({ organizzazione: org });
                      
                      const capienza = mezzo.capienza;
                      const residui = (capienza === undefined) ? '‚àû' : Math.max(capienza - nomi.length, 0);
                      alert(`Partecipanti aggiornati per ${mezzoNome} ‚Äî posti residui: ${residui}`);
                      
                      mostraSelezioneTuffo();
                  }
                  
                  function caricaImbarcazioni() {
                      const lista = document.getElementById('listaImbarcazioni');
                      lista.innerHTML = '';
                      const gitaRef = db.collection("gite").where("nome", "==", document.getElementById('titoloGita').textContent.split(' (')[0]);
                      gitaRef.get().then(querySnapshot => {
                          if (!querySnapshot.empty) {
                              const docId = querySnapshot.docs[0].id;
                              db.collection("gite").doc(docId).collection("imbarcazioni").get().then(snapshot => {
                                  snapshot.forEach(doc => {
                                      const imbarcazione = doc.data();
                                      const div = document.createElement('div');
                                      div.innerHTML = `${imbarcazione.nome} (${imbarcazione.tipologia}) - ${imbarcazione.capienza} posti ` +
                                      `<button onclick="eliminaImbarcazione('${doc.id}')">Elimina</button>`;
                                      lista.appendChild(div);
                                  });
                              });
                          }
                      });
                  }
                  
                  function eliminaImbarcazione(id) {
                      const nomeGita = document.getElementById('titoloGita').textContent.split(' (')[0];
                      const gitaRef = db.collection("gite").where("nome", "==", nomeGita);
                      
                      gitaRef.get().then(querySnapshot => {
                          if (querySnapshot.empty) return;
                          
                          const docId = querySnapshot.docs[0].id;
                          const gitaDocRef = db.collection("gite").doc(docId);
                          
                          // Recupera il nome dell‚Äôimbarcazione prima di tentare l‚Äôeliminazione
                          db.collection("gite").doc(docId).collection("imbarcazioni").doc(id).get().then(imbDoc => {
                              const imbarcazione = imbDoc.data();
                              const nomeImbarcazione = imbarcazione?.nome;
                              if (!nomeImbarcazione) return;
                              
                              gitaDocRef.get().then(doc => {
                                  const dati = doc.data();
                                  const organizzazione = dati.organizzazione || {};
                                  let trovata = false;
                                  
                                  for (const giorno in organizzazione) {
                                      for (const orario in organizzazione[giorno]) {
                                          const mezzi = organizzazione[giorno][orario] || [];
                                          const mezzo = mezzi.find(m => m.nome === nomeImbarcazione);
                                          if (mezzo && mezzo.persone && mezzo.persone.length > 0) {
                                              trovata = true;
                                              break;
                                          }
                                      }
                                      if (trovata) break;
                                  }
                                  
                                  if (trovata) {
                                      alert(`Impossibile eliminare "${nomeImbarcazione}" perch√© √® gi√† associata a dei partecipanti.`);
                                      return;
                                  }
                                  
                                  if (confirm(`Sei sicuro di voler eliminare "${nomeImbarcazione}"?`)) {
                                      db.collection("gite").doc(docId).collection("imbarcazioni").doc(id).delete()
                                      .then(() => {
                                          showMsg("Imbarcazione eliminata.");
                                          caricaImbarcazioni();
                                      });
                                  }
                              });
                          });
                      });
                  }
                  
                  async function caricaOrganizzazioneImmersione() {
                      if (!currentGitaId) return;
                      document.getElementById('organizzazioneImmersioneContainer').innerHTML = '';
                      const doc = await db.collection('gite').doc(currentGitaId).get();
                      const g = doc.data();
                      const tuffi = g.tuffi || {};
                      
                      const select = document.getElementById('menuTuffi');
                      select.innerHTML = '';
                      
                      const opDefault = document.createElement('option');
                      opDefault.value = '';
                      opDefault.textContent = '-- Seleziona --';
                      select.appendChild(opDefault);
                      
                      const giorni = Object.keys(tuffi).sort();
                      if (giorni.length === 0) {
                          const noOption = document.createElement('option');
                          noOption.textContent = 'Nessun tuffo disponibile';
                          noOption.disabled = true;
                          select.appendChild(noOption);
                          return;
                      }
                      
                      for (const giorno of giorni) {
                          const orari = tuffi[giorno].sort();
                          for (const orario of orari) {
                              const option = document.createElement('option');
                              option.value = `${giorno}|${orario}`;
                              const dataLabel = new Date(giorno).toLocaleDateString('it-IT');
                              option.textContent = `${dataLabel} - ${orario}`;
                              select.appendChild(option);
                          }
                      }
                      
                      // Autoseleziona il primo valido
                      if (select.options.length > 1) {
                          select.selectedIndex = 0;
                          mostraSelezioneTuffo();
                      }
                  }
                  /* ---------- Calendario Tuffi ---------- */
                  function caricaCalendarioTuffi(docId){
                      const cont=document.getElementById('tuffiContainer');
                      cont.innerHTML='';
                      db.collection('gite').doc(docId).get().then(d=>{
                          if(!d.exists) return; const g=d.data();
                          const start=new Date(g.dateRange[0]); const end=new Date(g.dateRange[1]);
                          for(let day=new Date(start);day<=end;day.setDate(day.getDate()+1)){
                              const iso=day.toISOString().split('T')[0];
                              const wrapper=document.createElement('div');
                              wrapper.className='giorno-tuffi';
                              wrapper.dataset.data=iso;
                              wrapper.innerHTML=`<strong>${day.toLocaleDateString('it-IT')}</strong> `;
                              const list=document.createElement('div'); list.className='lista-orari'; wrapper.appendChild(list);
                              const addBtn=document.createElement('button'); addBtn.textContent='Aggiungi orario';
                              addBtn.onclick=()=>addOrario(wrapper);
                              wrapper.appendChild(addBtn);
                              cont.appendChild(wrapper);
                              if(g.tuffi && g.tuffi[iso]) g.tuffi[iso].forEach(o=>addOrario(wrapper,o));
                          }
                      });
                  }
                  
                  function addOrario(wrapper,val=''){
                      const list=wrapper.querySelector('.lista-orari');
                      const span=document.createElement('span'); span.style.marginRight='5px';
                      const inp=document.createElement('input'); inp.type='time'; inp.value=val; span.appendChild(inp);
                      // Controlla se l'orario √® gi√† presente per lo stesso giorno
                      const orariEsistenti = wrapper.querySelectorAll("input[type='time']");
                      for (const o of orariEsistenti) {
                          if (o.value === val && val !== '') {
                              alert("Questo orario √® gi√† stato aggiunto.");
                              return;
                          }
                      }
                      const del = document.createElement('button');
                      del.textContent = 'X';
                      del.style.marginLeft = '2px';
                      del.onclick = async () => {
                          const giorno = wrapper.dataset.data;
                          const orario = inp.value;
                          
                          const doc = await db.collection("gite").doc(currentGitaId).get();
                          const dati = doc.data();
                          const organizzazione = dati.organizzazione || {};
                          const presenze = dati.presenze || {};
                          
                          const mezzi = organizzazione[giorno]?.[orario] || [];
                          const haOrganizzazione = Array.isArray(mezzi) && mezzi.length > 0;
                          
                          let haPresenze = false;
                          for (const nome in presenze) {
                              if (presenze[nome]?.[`${giorno}|${orario}`] !== undefined) {
                                  haPresenze = true;
                                  break;
                              }
                          }
                          
                          if (haOrganizzazione || haPresenze) {
                              alert("Non puoi eliminare questo orario: √® gi√† presente in una organizzazione o tra le presenze.");
                              return;
                          }
                          
                          if (confirm('Rimuovere questo orario?')) span.remove();
                      };
                      
                      
                      span.appendChild(del);
                      list.appendChild(span);
                  }
                  
                  function salvaTuffi() {
                      if (!currentGitaId) return;
                      const giorni = Array.from(document.querySelectorAll("[data-data]")).map(w => w.dataset.data);
                      const dati = {};
                      
                      giorni.forEach(giorno => {
                          const wrapper = document.querySelector(`[data-data='${giorno}']`);
                          const orari = Array.from(wrapper.querySelectorAll("input[type='time']"))
                          .map(i => i.value)
                          .filter(Boolean);
                          
                          // Rimuove duplicati
                          const orariUnici = [...new Set(orari)];
                          
                          // Ordina cronologicamente stabile
                          orariUnici.sort((a, b) => {
                              const [ah, am] = a.split(':').map(Number);
                              const [bh, bm] = b.split(':').map(Number);
                              return (ah * 60 + am) - (bh * 60 + bm);
                          });
                          
                          dati[giorno] = orariUnici;
                      });
                      
                      // Ora controlla se si stanno rimuovendo orari che hanno organizzazione o presenze
                      db.collection('gite').doc(currentGitaId).get().then(async doc => {
                          const gita = doc.data();
                          const organizzazione = gita.organizzazione || {};
                          const vecchiTuffi = gita.tuffi || {};
                          const presenze = gita.presenze || {};
                          const nuovaOrganizzazione = {};
                          
                          for (const giorno in dati) {
                              nuovaOrganizzazione[giorno] = {};
                              const nuoviOrari = dati[giorno];
                              const vecchiOrari = vecchiTuffi[giorno] || [];
                              
                              for (const vecchioOrario of vecchiOrari) {
                                  if (!nuoviOrari.includes(vecchioOrario)) {
                                      const mezzi = organizzazione[giorno]?.[vecchioOrario] || [];
                                      const haOrganizzazione = Array.isArray(mezzi) && mezzi.length > 0;
                                      
                                      if (haOrganizzazione) {
                                          alert(`Non puoi rimuovere l'orario ${vecchioOrario} del giorno ${giorno}: √® gi√† presente in una organizzazione.`);
                                          return;
                                      }
                                      
                                      for (const nome in presenze) {
                                          if (presenze[nome]?.[`${giorno}|${vecchioOrario}`] !== undefined) {
                                              alert(`Non puoi rimuovere l'orario ${vecchioOrario} del giorno ${giorno}: √® presente tra le presenze.`);
                                              return;
                                          }
                                      }
                                  }
                              }
                              
                              // Trasferisce le associazioni gi√† presenti
                              nuoviOrari.forEach(nuovoOrario => {
                                  if (organizzazione[giorno]?.[nuovoOrario]) {
                                      nuovaOrganizzazione[giorno][nuovoOrario] = JSON.parse(JSON.stringify(organizzazione[giorno][nuovoOrario]));
                                  } else {
                                      nuovaOrganizzazione[giorno][nuovoOrario] = [];
                                  }
                              });
                          }
                          
                          // Aggiorna Firebase
                          await db.collection('gite').doc(currentGitaId).update({
                              tuffi: dati,
                              organizzazione: nuovaOrganizzazione
                          });
                          
                          alert("Orari tuffi salvati con successo.");
                          
                      });
                  }
                  
                  function esportaElencoPresenze() {
                      const docRef = db.collection("gite").doc(currentGitaId);
                      
                      docRef.get().then((docSnap) => {
                          if (!docSnap.exists) {
                              alert("Documento gita non trovato.");
                              return;
                          }
                          
                          const gita = docSnap.data();
                          const presenze = gita.presenze || {};
                          const partecipanti = gita.partecipanti || [];
                          
                          const datiPartecipanti = {};
                          partecipanti.forEach(p => {
                              datiPartecipanti[p.nome] = {
                                  corso: p.corso || "",
                                  categoria: p.categoria || ""
                              };
                          });
                          
                          const tutteLeDate = new Set();
                          for (const nome in presenze) {
                              Object.keys(presenze[nome]).forEach(dataOra => tutteLeDate.add(dataOra));
                          }
                          
                          const dateOrdinata = Array.from(tutteLeDate).sort();
                          const intestazioniFormattate = dateOrdinata.map(dt => {
                              const [data, ora] = dt.split("|");
                              const [aaaa, mm, gg] = data.split("-");
                              return `${gg}-${mm}-${aaaa} | ${ora}`;
                          });
                          
                          const staff = [];
                          const allievi = [];
                          
                          for (const nome in presenze) {
                              const corso = datiPartecipanti[nome]?.corso || "";
                              const categoria = datiPartecipanti[nome]?.categoria || "";
                              
                              const riga = {
                                  Nome: nome,
                                  Corso: corso,
                                  Categoria: categoria
                              };
                              let count = 0;
                              
                              dateOrdinata.forEach((dt, i) => {
                                  const presenza = presenze[nome][dt];
                                  riga[intestazioniFormattate[i]] = presenza === true ? "x" : "";
                                  if (presenza === true) count++;
                              });
                              
                              riga["Totale"] = count;
                              
                              if (categoria.toLowerCase() === "staff") {
                                  staff.push(riga);
                              } else {
                                  allievi.push(riga);
                              }
                          }
                          
                          // Ordina i nomi alfabeticamente
                          staff.sort((a, b) => a.Nome.localeCompare(b.Nome));
                          allievi.sort((a, b) => a.Nome.localeCompare(b.Nome));
                          const dati = [...staff, {}, ...allievi];
                          
                          const header = ["Nome", "Corso", "Categoria", ...intestazioniFormattate, "Totale"];
                          const worksheet = XLSX.utils.json_to_sheet(dati, { header: header });
                          
                          // Imposta larghezza colonne in base al contenuto
                          worksheet['!cols'] = header.map(h => {
                              const maxLen = Math.max(
                                                      h.length,
                                                      ...dati.map(row => row && row[h] ? String(row[h]).length : 0)
                                                      );
                                                      return { wch: maxLen + 2 };
                          });
                          
                          const workbook = XLSX.utils.book_new();
                          XLSX.utils.book_append_sheet(workbook, worksheet, "Presenze");
                          
                          // Costruzione del nome file
                          const nomeGita = (gita.nome || "Gita").replace(/\s+/g, "_");
                          const primaData = dateOrdinata[0]?.split("|")[0];
                          const ultimaData = dateOrdinata[dateOrdinata.length - 1]?.split("|")[0];
                          const formatData = d => {
                              const [yyyy, mm, dd] = d.split("-");
                              return `${dd}_${mm}`;
                          };
                          const periodo = `${formatData(primaData)}_${formatData(ultimaData)}`;
                          const nomeFile = `Elenco_Presenze_${nomeGita}_${periodo}.xlsx`;
                          
                          XLSX.writeFile(workbook, nomeFile);
                          
                      }).catch((error) => {
                          console.error("Errore durante l'esportazione:", error);
                          alert("Errore durante l'esportazione. Controlla la console.");
                      });
                  }
                  
                  function listaPartecipantiHTML(arr){
                      if (!arr.length) return '<em>Nessun partecipante</em>';
                      return '<table><tr><th>Nome</th><th>Categoria</th><th>Corso</th></tr>' +
                      arr.map(p=>`<tr><td>${p.nome}</td><td>${p.categoria}</td><td>${p.corso||''}</td></tr>`).join('') +
                      '</table>';
                  }
                  function riepilogoHTML(arr){
                      if (!arr.length) return '<em>Nessun partecipante</em>';
                      const map = {};
                      arr.forEach(p => {
                          const c = p.corso || 'Nessun corso';
                          const cat = p.categoria?.toLowerCase() || '';
                          if (!map[c]) map[c] = { utenti: 0, staff: 0 };
                          if (['istruttore','aiutoistruttore','divemaster'].includes(cat)) {
                              map[c].staff++;
                          } else {
                              map[c].utenti++;
                          }
                      });
                      
                      let h = `<p><strong>Totale Subacquei: ${arr.length}</strong></p>`;
                      h += '<table><tr><th>Corso</th><th>Utenti</th><th>Staff</th><th>Totale</th></tr>';
                      Object.entries(map).forEach(([corso, v]) => {
                          h += `<tr><td>${corso}</td><td>${v.utenti}</td><td>${v.staff}</td><td>${v.utenti + v.staff}</td></tr>`;
                      });
                      h += '</table>';
                      return h;
                  }
                  
                  /***** Importazione Iscritti *****/
                  let tmpIscritti=[];
                  function preElaboraIscritti(event) {
                      const file = event.target.files[0];
                      if (!file || !currentGitaId) return;
                      
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          const data = new Uint8Array(e.target.result);
                          const workbook = XLSX.read(data, { type: 'array' });
                          const sheetName = workbook.SheetNames[0];
                          const sheet = workbook.Sheets[sheetName];
                          const jsonRaw = XLSX.utils.sheet_to_json(sheet);
                          
                          if (!jsonRaw.length) {
                              alert("‚ö†Ô∏è Il file √® vuoto o non contiene dati.");
                              return;
                          }
                          
                          // Controlla che tutte le righe abbiano "Nome e Cognome", "Categoria", "Corso"
                          const validi = jsonRaw.every(r =>
                                                       typeof r["Nome e Cognome"] === 'string' && r["Nome e Cognome"].trim() !== '' &&
                                                       typeof r["Categoria"] === 'string' && r["Categoria"].trim() !== '' &&
                                                       typeof r["Corso"] === 'string' && r["Corso"].trim() !== ''
                                                       );
                                                       
                                                       if (!validi) {
                                                           alert("‚ö†Ô∏è Ogni riga deve contenere i campi: 'Nome e Cognome', 'Categoria' e 'Corso'.");
                                                           return;
                                                       }
                                                       
                                                       // Mappa i dati con nomi standardizzati
                                                       const partecipanti = jsonRaw.map(r => ({
                                                           nome: r["Nome e Cognome"].trim(),
                                                           categoria: r["Categoria"].trim(),
                                                           corso: r["Corso"].trim()
                                                       }));
                                                       
                                                       // Salva su Firebase
                                                       db.collection("gite").doc(currentGitaId).update({
                                                           partecipanti: partecipanti
                                                       })
                                                       .then(() => {
                                                           showMsg("‚úÖ Iscritti importati con successo.");
                                                           caricaPartecipantiEsistenti();
                                                           aggiornaStatistichePerCorso();
                                                       })
                                                       .catch(err => {
                                                           console.error("Errore durante il salvataggio:", err);
                                                           alert("‚ùå Errore durante l'importazione su Firebase.");
                                                       });
                      };
                      
                      reader.readAsArrayBuffer(file);
                  }
                  
                  
                  function mostraRiepilogoIscritti(){
                      const wrap=document.getElementById('riepilogoIscritti');
                      if(!tmpIscritti.length){wrap.textContent='';return;}
                      const riepilogo={};
                      tmpIscritti.forEach(p=>{
                          const corso=p.corso||'Nessun corso';
                          const cat=p.categoria.toLowerCase();
                          if(!riepilogo[corso]) riepilogo[corso]={utenti:0,staff:0};
                          ['istruttore','aiutoistruttore','divemaster'].includes(cat)?riepilogo[corso].staff++:riepilogo[corso].utenti++;
                      });
                      let html=`<p><strong>Totale Subacquei: ${tmpIscritti.length}</strong></p>`;
                      html+='<table><tr><th>Corso</th><th>Utenti</th><th>Staff</th><th>Totale</th></tr>';
                      Object.entries(riepilogo).forEach(([c,v])=>{
                          html+=`<tr><td>${c}</td><td>${v.utenti}</td><td>${v.staff}</td><td>${v.utenti+v.staff}</td></tr>`;
                      });
                      html+='</table>';
                      wrap.innerHTML=html;
                  }
                  function listaPartecipantiHTML(arr){
                      if(!arr.length) return '<em>Nessun partecipante</em>';
                      return '<table><tr><th>Nome</th><th>Categoria</th><th>Corso</th></tr>'+
                      arr.map(p=>`<tr><td>${p.nome}</td><td>${p.categoria}</td><td>${p.corso||''}</td></tr>`).join('')+
                      '</table>';
                  }
                  
                  function salvaModificaPartecipante(index) {
                      const table = document.querySelector("#listaPartecipantiSalvati table");
                      if (!table || index + 1 >= table.rows.length) return;
                      
                      const row = table.rows[index + 1]; // +1 per saltare header
                      
                      const nomeInput = row.cells[0].querySelector("input");
                      const selectCorso = row.cells[1].querySelector("select");
                      const selectCategoria = row.cells[2].querySelector("select");
                      
                      const nome = nomeInput?.value.trim() || "";
                      const corso = selectCorso?.value.trim() || "";
                      const categoria = selectCategoria?.value.trim() || "";
                      
                      if (!nome) {
                          alert("Nome non valido.");
                          return;
                      }
                      
                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const gita = doc.data();
                          const partecipanti = gita.partecipanti || [];
                          
                          const idx = partecipanti.findIndex(p => p.nome === nome);
                          if (idx >= 0) {
                              partecipanti[idx].corso = corso;
                              partecipanti[idx].categoria = categoria;
                              
                              db.collection("gite").doc(currentGitaId).update({
                                  partecipanti: partecipanti
                              }).then(() => {
                                  alert(`Dati aggiornati per ${nome}`);
                                  aggiornaStatistichePerCorso();
                              }).catch(error => {
                                  console.error("Errore salvataggio Firebase:", error);
                                  alert("Errore durante il salvataggio.");
                              });
                          } else {
                              alert("Partecipante non trovato.");
                          }
                      }).catch(error => {
                          console.error("Errore lettura Firebase:", error);
                          alert("Errore nel recupero dati.");
                      });
                  }
                  
                  
                  
                  function caricaPartecipantiEsistenti() {
                      if (!currentGitaId) return;
                      
                      const container = document.getElementById("listaPartecipantiSalvati");
                      container.innerHTML = "";
                      
                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const gita = doc.data();
                          const partecipanti = gita.partecipanti || [];
                          
                          if (partecipanti.length === 0) {
                              container.textContent = "Nessun partecipante registrato.";
                              return;
                          }
                          
                          const table = document.createElement("table");
                          table.border = 1;
                          table.style.width = "100%";
                          table.style.minWidth = "500px";
                          
                          const thead = document.createElement("thead");
                          thead.innerHTML = `
      <tr>
        <th>Nome</th>
        <th>Corso</th>
        <th>Categoria</th>
        <th>Azioni</th>
      </tr>
    `;
    table.appendChild(thead);
    
    const tbody = document.createElement("tbody");
    const corsiUnici = [...new Set(partecipanti.map(p => p.corso).filter(Boolean))].sort();
    
    partecipanti.forEach((p, index) => {
        const tr = document.createElement("tr");
        
        // NOME (non modificabile)
        const tdNome = document.createElement("td");
        const inputNome = document.createElement("input");
        inputNome.type = "text";
        inputNome.value = p.nome;
        inputNome.disabled = true;
        tdNome.appendChild(inputNome);
        tr.appendChild(tdNome);
        
        // CORSO
        const tdCorso = document.createElement("td");
        const selectCorso = document.createElement("select");
        selectCorso.className = "corso-dropdown";
        
        corsiUnici.forEach(corso => {
            const opt = document.createElement("option");
            opt.value = corso;
            opt.textContent = corso;
            if (corso === p.corso) opt.selected = true;
            selectCorso.appendChild(opt);
        });
        
        const optAltro = document.createElement("option");
        optAltro.value = "__altro__";
        optAltro.textContent = "Altro...";
        selectCorso.appendChild(optAltro);
        
        selectCorso.addEventListener("change", function () {
            if (this.value === "__altro__") {
                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = "Nuovo corso";
                input.onblur = () => {
                    const nuovo = input.value.trim();
                    if (nuovo) {
                        const nuovaOpt = document.createElement("option");
                        nuovaOpt.value = nuovo;
                        nuovaOpt.textContent = nuovo;
                        this.insertBefore(nuovaOpt, optAltro);
                        this.value = nuovo;
                        input.remove();
                    }
                };
                tdCorso.appendChild(input);
                input.focus();
            }
        });
        
        tdCorso.appendChild(selectCorso);
        tr.appendChild(tdCorso);
        
        // CATEGORIA
        const tdCat = document.createElement("td");
        const selCat = document.createElement("select");
        
        const categorieStandard = ["allievo", "sub", "istruttore", "aiutoIstruttore", "divemaster"];
        const categoriaFirebase = p.categoria?.trim() || "";
        
        categorieStandard.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.textContent = cat;
            if (cat === categoriaFirebase) opt.selected = true;
            selCat.appendChild(opt);
        });
        
        if (categoriaFirebase && !categorieStandard.includes(categoriaFirebase)) {
            const optAltro = document.createElement("option");
            optAltro.value = categoriaFirebase;
            optAltro.textContent = categoriaFirebase;
            optAltro.selected = true;
            selCat.appendChild(optAltro);
        }
        
        tdCat.appendChild(selCat);
        tr.appendChild(tdCat);
        
        // SALVA
        const tdBtn = document.createElement("td");
        const btnSalva = document.createElement("button");
        btnSalva.textContent = "üíæ Salva";
        btnSalva.onclick = () => salvaModificaPartecipante(index);
        tdBtn.appendChild(btnSalva);
        tr.appendChild(tdBtn);
        
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
                      });
                  }
                  
                  function aggiornaStatistichePerCorso() {
                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const partecipanti = doc.data().partecipanti || [];
                          const riepilogo = {};
                          
                          // Conta Allievi / Sub / Staff per corso
                          partecipanti.forEach(p => {
                              const corso = p.corso?.trim() || "Senza Corso";
                              const categoria = (p.categoria?.trim().toLowerCase()) || "";
                              
                              if (!riepilogo[corso]) {
                                  riepilogo[corso] = { allievi: 0, sub: 0, staff: 0 };
                              }
                              
                              if (categoria === "allievo") {
                                  riepilogo[corso].allievi++;
                              } else if (categoria === "sub") {
                                  riepilogo[corso].sub++;
                              } else {
                                  riepilogo[corso].staff++;
                              }
                          });
                          
                          // Totali globali
                          let totAllievi = 0, totSub = 0, totStaff = 0;
                          Object.values(riepilogo).forEach(r => {
                              totAllievi += r.allievi;
                              totSub += r.sub;
                              totStaff += r.staff;
                          });
                          const totGenerale = totAllievi + totSub + totStaff;
                          
                          // Costruzione tabella
                          const container = document.getElementById("riepilogoIscritti");
                          container.innerHTML = "<h4>Riepilogo Partecipanti per Corso</h4>";
                          
                          const table = document.createElement("table");
                          table.style.borderCollapse = "collapse";
                          table.style.width = "100%";
                          table.style.marginTop = "10px";
                          
                          const headerRow = `
      <tr style="background-color:#f0f0f0; font-weight:bold;">
        <th style="border:1px solid #ccc; padding:6px;">Corso</th>
        <th style="border:1px solid #ccc; padding:6px;">Allievi</th>
        <th style="border:1px solid #ccc; padding:6px;">Sub</th>
        <th style="border:1px solid #ccc; padding:6px;">Staff</th>
        <th style="border:1px solid #ccc; padding:6px;">Totale</th>
      </tr>
    `;
    table.innerHTML = headerRow;
    
    const rowTotaleGenerale = `
      <tr style="font-weight:bold;">
        <td style="border:1px solid #ccc; padding:6px;">Totale Generale</td>
        <td style="border:1px solid #ccc; padding:6px;">${totAllievi}</td>
        <td style="border:1px solid #ccc; padding:6px;">${totSub}</td>
        <td style="border:1px solid #ccc; padding:6px;">${totStaff}</td>
        <td style="border:1px solid #ccc; padding:6px;">${totGenerale}</td>
      </tr>
    `;
    table.innerHTML += rowTotaleGenerale;
    
    Object.entries(riepilogo).forEach(([corso, dati]) => {
        const totale = dati.allievi + dati.sub + dati.staff;
        const row = `
        <tr>
          <td style="border:1px solid #ccc; padding:6px;">${corso}</td>
          <td style="border:1px solid #ccc; padding:6px;">${dati.allievi}</td>
          <td style="border:1px solid #ccc; padding:6px;">${dati.sub}</td>
          <td style="border:1px solid #ccc; padding:6px;">${dati.staff}</td>
          <td style="border:1px solid #ccc; padding:6px;">${totale}</td>
        </tr>
      `;
      table.innerHTML += row;
    });
    
    container.appendChild(table);
                      });
                  }
                  
                  function esportaRiepilogo() {
                      db.collection("gite").doc(currentGitaId).get().then(doc => {
                          const dati = doc.data();
                          const organizzazione = dati.organizzazione || {};
                          const nomeGita = dati.nome || "Gita";
                          const dateRange = dati.dateRange || [];
                          const start = dateRange[0] ? new Date(dateRange[0]) : null;
                          const end = dateRange[1] ? new Date(dateRange[1]) : null;
                          
                          const formatterDataCompleta = new Intl.DateTimeFormat('it-IT', {
                              weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'
                          });
                          
                          const periodo = start && end
                          ? formatterDataCompleta.format(start) + (start.toDateString() !== end.toDateString()
                                                                   ? ` - ${formatterDataCompleta.format(end)}`
                                                                   : '')
                                                                   : '';
                                                                   
                                                                   const wb = XLSX.utils.book_new();
                                                                   const ws = XLSX.utils.aoa_to_sheet([]);
                                                                   
                                                                   const header = [
                                                                                   "Orario",
                                                                                   "Imbarcazione",
                                                                                   "Tipo",
                                                                                   "Capienza",
                                                                                   "Corsi",
                                                                                   "Totale Sub",
                                                                                   "Allievi/Sub",
                                                                                   "Staff",
                                                                                   "Punto di immersione",
                                                                                   "Profondit√† Massima"
                                                                                   ];
                                                                                   
                                                                                   const COL_COUNT = header.length;
                                                                                   const merges = [];
                                                                                   
                                                                                   // Riga 0: Titolo nella prima riga (unita)
                                                                                   const titolo = [`${nomeGita} ‚Äì ${periodo}`, ...Array(COL_COUNT - 1).fill("")];
                                                                                   XLSX.utils.sheet_add_aoa(ws, [titolo], { origin: "A1" });
                                                                                   merges.push({ s: { r: 0, c: 0 }, e: { r: 0, c: COL_COUNT - 1 } });
                                                                                   
                                                                                   let rigaCorrente = 1; // gi√† inserita riga 0 con titolo
                                                                                   
                                                                                   const giorni = Object.keys(organizzazione).sort();
                                                                                   
                                                                                   giorni.forEach(giorno => {
                                                                                       const orari = Object.keys(organizzazione[giorno]).sort();
                                                                                       
                                                                                       // Riga con data (non unita)
                                                                                       const dataCompleta = formatterDataCompleta.format(new Date(giorno));
                                                                                       const rigaData = [dataCompleta, ...Array(COL_COUNT - 1).fill("")];
                                                                                       XLSX.utils.sheet_add_aoa(ws, [rigaData], { origin: `A${rigaCorrente + 1}` });
                                                                                       rigaCorrente++;
                                                                                       
                                                                                       // Intestazioni
                                                                                       XLSX.utils.sheet_add_aoa(ws, [header], { origin: `A${rigaCorrente + 1}` });
                                                                                       rigaCorrente++;
                                                                                       
                                                                                       orari.forEach(orario => {
                                                                                           const mezzi = organizzazione[giorno][orario] || [];
                                                                                           
                                                                                           mezzi.forEach(mezzo => {
                                                                                               const partecipanti = mezzo.persone || [];
                                                                                               
                                                                                               let countUtenti = 0;
                                                                                               let countStaff = 0;
                                                                                               const corsi = new Set();
                                                                                               
                                                                                               partecipanti.forEach(p => {
                                                                                                   const nome = typeof p === "string" ? p : p.nome;
                                                                                                   const corso = typeof p === "object" ? (p.corso || '') : '';
                                                                                                   const categoria = typeof p === "object" ? (p.categoria || '') : '';
                                                                                                   
                                                                                                   const catLower = categoria.toLowerCase();
                                                                                                   if (["istruttore", "aiutoistruttore", "divemaster"].includes(catLower)) {
                                                                                                       countStaff++;
                                                                                                   } else {
                                                                                                       countUtenti++;
                                                                                                   }
                                                                                                   
                                                                                                   if (corso) corsi.add(corso);
                                                                                               });
                                                                                               
                                                                                               const riga = [
                                                                                                             orario,
                                                                                                             mezzo.nome,
                                                                                                             mezzo.tipo,
                                                                                                             mezzo.capienza || '‚àû',
                                                                                                             [...corsi].sort().join(", "),
                                                                                                             partecipanti.length,
                                                                                                             countUtenti,
                                                                                                             countStaff,
                                                                                                             mezzo.punto || '',
                                                                                                             mezzo.profondita || ''
                                                                                                             ];
                                                                                                             
                                                                                                             XLSX.utils.sheet_add_aoa(ws, [riga], { origin: `A${rigaCorrente + 1}` });
                                                                                                             rigaCorrente++;
                                                                                           });
                                                                                       });
                                                                                   });
                                                                                   
                                                                                   ws["!merges"] = merges;
                                                                                   ws["!cols"] = header.map(() => ({ wch: 20 }));
                                                                                   
                                                                                   const nomeFile = `Riepilogo_Immersioni_${nomeGita.replace(/\s+/g, "_")}.xlsx`;
                                                                                   XLSX.utils.book_append_sheet(wb, ws, "Riepilogo");
                                                                                   XLSX.writeFile(wb, nomeFile);
                      });
                  }
                  
                  function titoloCella(nomeGita, periodo, colCount) {
                      return [nomeGita + (periodo ? " ‚Äì " + periodo : ""), ...Array(colCount - 1).fill("")];
                  }
                  
                  async function mostraApp() {
                      const email = auth.currentUser.email;
                      
                      document.getElementById("authSection").classList.add("hidden");
                      document.getElementById("mainApp").classList.remove("hidden");
                      
                      flatpickr('#dateGita', { mode: 'range', dateFormat: 'Y-m-d' });
                      
                      // üîì Admin: accesso completo a tutto
                      if (adminEmails.includes(email)) {
                          document.getElementById('apriImpostazioni').style.display = 'inline-block';
                          document.getElementById('bloccoAggiungiGita').style.display = 'block';
                      } else {
                          // üîç Recupera il tipo di utente dal DB
                          const doc = await db.collection("utenti").doc(email).get();
                          const dati = doc.data();
                          const tipo = dati?.tipo || "Limitato";
                          
                          // Mostra/Nasconde il blocco Aggiungi Gita
                          if (tipo === "Completo") {
                              document.getElementById('bloccoAggiungiGita').style.display = 'block';
                          } else {
                              document.getElementById('bloccoAggiungiGita').style.display = 'none';
                          }
                          
                          // Impedisce la visione delle impostazioni
                          document.getElementById('apriImpostazioni').style.display = 'none';
                      }
                      
                      loadGite();
                  }
                  
                  function formatTitolo(s) {
                      return (s || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                  }
                  
                  
                  auth.onAuthStateChanged(async (user) => {
                      document.getElementById('loader').style.display = 'none';
                      
                      if (user) {
                          currentUser = user;
                          const email = user.email;
                          
                          if (adminEmails.includes(email)) {
                              // Ritardo di 2 secondi prima di mostrare l'app per admin
                              setTimeout(() => {
                                  document.getElementById('loader').style.display = 'none';
                                  mostraApp();
                              }, 2000);
                              return;
                          }
                          
                          try {
                              const doc = await db.collection("utenti").doc(email).get();
                              const dati = doc.data();
                              
                              if (dati && dati.approvato === true) {
                                  mostraApp(); // accesso per utenti approvati
                              } else {
                                  document.getElementById("authMessage").innerHTML = "Accesso in attesa di approvazione.";
                                  auth.signOut();
                                  document.getElementById('authSection').classList.remove('hidden');
                              }
                          } catch (err) {
                              console.error("Errore durante il controllo approvazione:", err);
                              document.getElementById("authMessage").innerHTML = "Errore durante l'accesso. Riprova.";
                              document.getElementById('authSection').classList.remove('hidden');
                          }
                      } else {
                          // utente non loggato
                          currentUser = null;
                          document.getElementById('loader').style.display = 'none';
                          document.getElementById('authSection').style.display = 'block';
                      }
                  });
                  
                  
              }
              
              
          </script>
          
</body>
</html>




